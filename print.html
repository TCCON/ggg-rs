<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>GGG-RS User Guide</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="./mdbook-admonish.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">GGG-RS User Guide</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/TCCON/ggg-rs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="overview"><a class="header" href="#overview">Overview</a></h1>
<p>GGG-RS is an extension to <a href="https://github.com/TCCON/GGG">the GGG retrieval</a> that provides updated version of several of the post-processing programs.
The long term intention is to also make this a library of functions useful for working with GGG-related files.</p>
<h2 id="installation"><a class="header" href="#installation">Installation</a></h2>
<p>At present, installing GGG-RS requires that you be able to build it from source.
This requires, at a minimum, a <a href="https://rustup.rs/">Rust toolchain</a> installed.
If you wish to compile the programs that work with netCDF files, you will also need either</p>
<ul>
<li>one of the <code>micromamba</code>, <code>mamba</code>, or <code>conda</code> package managers, or</li>
<li>the <code>cmake</code> build tool.</li>
</ul>
<p>These are necessary to install or build the netCDF and HDF5 C libraries.
Detailed instructions and installation options are provided in the <a href="https://github.com/TCCON/ggg-rs">README</a>.</p>
<h2 id="documentation"><a class="header" href="#documentation">Documentation</a></h2>
<p>This book primarily focues on the command line programs provided by GGG-RS.
As the library is made available, the APIs will be documented through <a href="https://docs.rs/">docs.rs</a> (for the Rust library) and <code>readthedocs.io</code> (for the Python library).</p>
<p>Each command line program will provide help when given the <code>-h</code> or <code>--help</code> flags.
That help should be your first resource to understand how the programs work, as it will be the most up-to-date.
The chapters in this book go into more detail about advanced usage of the programs.
If you find something in this book that is out of date or unclear, please <a href="https://github.com/TCCON/ggg-rs/issues">open an issue</a> or <a href="https://github.com/TCCON/ggg-rs/pulls">pull request</a> with the <code>documentation</code> tag.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contributing"><a class="header" href="#contributing">Contributing</a></h1>
<p>The best documentation is the result of collaboration between users and developers with different perspectives.
As developers, it is easy for us to assume users have certain background knowledge that, in reality, we only
have because we are so immersed in this codebase.
In general, if you see something that is unclear, missing, or out of date in this book, please
<a href="https://github.com/TCCON/ggg-rs/issues">open an issue</a> or, even better, a <a href="https://github.com/TCCON/ggg-rs/pulls">pull request</a>
on the GGG-RS repo, with the "documentation" tag.</p>
<h2 id="contribution-criteria"><a class="header" href="#contribution-criteria">Contribution criteria</a></h2>
<p>Requests to update the documentation will be evaluated on several criteria, primarily:</p>
<ul>
<li>accuracy (does the change correctly reflect the behavior of the program?),</li>
<li>clarity (is the change easy to understand and as concise as possible?), and</li>
<li>scope (does the change add information that should be included in that location, or is it better suited to another source?)</li>
</ul>
<p>When opening an issue, providing as much information as possible will help it be resolved quickly,
as will responding promptly when asked for more input. Likewise, when opening a pull request, providing
a clear description of what was changed and why will help us review it efficiently. If you are providing
a pull request, please verify that the edits render correctly by following the instructions in <a href="contributing.html#building-the-book">Building the book</a>,
below.</p>
<p>We reserve the right to turn down requests for changes if, in our opinion, they make the documentation worse,
or if the requestor does not provide sufficient information to make the needed change clear.
Well explained and respectful requests will usually be accepted.</p>
<h2 id="common-types-of-questions"><a class="header" href="#common-types-of-questions">Common types of questions</a></h2>
<p>Below are some common questions and details on what sort of information to provide when asking for an update to
help us resolve the problem efficiently.</p>
<h3 id="the-information-i-need-is-not-where-i-expected"><a class="header" href="#the-information-i-need-is-not-where-i-expected">The information I need is not where I expected</a></h3>
<p>When opening an issue, be clear about what information you are trying to find, where you expected to find
it in the documentation, and why you were looking there.
Understanding how you expect the information to be organized helps us examine if there might be other ways
we need to connect different parts of the documentation.
Generally, the best fix for this problem is to identify where a link between parts of the documentation will
help guide people to the correct page.
Other solutions may be appropriate in more complicated cases.</p>
<h3 id="a-program-is-not-included-in-the-book"><a class="header" href="#a-program-is-not-included-in-the-book">A program is not included in the book</a></h3>
<p>First, please check that it is one of the GGG-RS programs.
This means it will have a folder under the <code>src/bin</code> subdirectory of the <a href="https://github.com/TCCON/ggg-rs">repository</a>.
The GGG-RS programs will coexist with regular GGG and EGI-RS programs in <code>$GGGPATH/bin/</code>, so just because a program
exists there does not mean it will be documented here.</p>
<p>If a program really is missing, then either open an issue or create a pull request that add it.
If creating a pull request, please match the structure of the existing programs' documentation.</p>
<h3 id="i-do-not-understand-what-the-documentation-is-trying-to-explain"><a class="header" href="#i-do-not-understand-what-the-documentation-is-trying-to-explain">I do not understand what the documentation is trying to explain</a></h3>
<p>When you encounter something that is not clear, please first try to figure it out yourself by following any
examples and testing things out.
If that section of the documentation links to external resources (e.g., the <a href="https://toml.io/en/">TOML format</a>),
please review those resources as well.</p>
<p>If something truly is unclear, then open an issue and do your best to explain what you were trying to accomplish
and what you found difficult to understand.
Explaining the overall task you were trying to accomplish, as well as the part of the documentation that you
found unclear, will help us identify if this is an <a href="https://en.wikipedia.org/wiki/XY_problem">XY problem</a>, where
the reason it was unclear is because there is a better solution to your task than the one you were trying to use.</p>
<h2 id="building-the-book"><a class="header" href="#building-the-book">Building the book</a></h2>
<p>If you want to edit this book, it lives in the <code>book</code> subdirectory of the <a href="https://github.com/TCCON/ggg-rs">GGG-RS repo</a>.
The source code is in Markdown, and can be edited with any plain text editor (e.g., Notepad, TextEdit, vim, nano) or
code editor (e.g., VSCode).
It is built with <a href="https://github.com/rust-lang/mdBook">mdbook</a> with the additional
<a href="https://github.com/tommilligan/mdbook-admonish">mdbook-admonish</a> preprocessor.</p>
<p>To check that the book renders correctly when making edits:</p>
<ul>
<li>Install both <code>mdbook</code> and <code>mdbook-admonish</code> follow the instructions in their repositories.</li>
<li>In the <code>book</code> subdirectory of GGG-RS repository (which you will have cloned to your computer), run <code>mdbook serve</code>.</li>
<li>Copy the "localhost" link it prints and paste it into any web browser.</li>
</ul>
<p>You will see the rendered local copy of the book, and it will automatically update each time you make changes.</p>
<p>Please do this before submitting any pull requests, as it will slow things down significantly if we have to iterate
multiple times with you to ensure the book builds correctly.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="setup-helper-programs"><a class="header" href="#setup-helper-programs">Setup helper programs</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="change_ggg_files"><a class="header" href="#change_ggg_files">change_ggg_files</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="list_spectra"><a class="header" href="#list_spectra">list_spectra</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="post-processing-programs"><a class="header" href="#post-processing-programs">Post processing programs</a></h1>
<p>Post processing programs are used after completing GFIT runs on all windows.
These programs perform a combination of collating and averaging data from the different
windows and applying the necessary <em>post hoc</em> corrections to produce the best quality data.</p>
<p>We are currently in a transitional period, where the post processing programs are still
provided in a mix of languages.
Some remain the original Fortran versions from GGG2020, others have been replaces with Rust
versions, and the private netCDF writer remains written in Python.
The intention is to transition away from the Python netCDF writer in GGG2020.2,
but to retain a mix of Fortran and Rust programs at that time.
Whether all post processing programs transition to Rust depends on whether there is a need
for more flexibility in all programs.</p>
<h2 id="em27sun-users"><a class="header" href="#em27sun-users">EM27/SUN users</a></h2>
<p>Those who use GGG to process EM27/SUN data must be aware that EGI (the wrapper program to
streamline processing of EM27/SUN data with GGG) is <em>also</em> in a transitional phase.
The <a href="https://tccon-wiki.caltech.edu/Main/EGI">original EGI</a> does not use GGG-RS programs,
and instead patches some of the existing GGG Fortran programs to work with EM27/SUN data,
as well as works around some limitations of the Fortran post processing code by swapping
out some of the configuration files on disk.
This works, but is inconvenient when you need to process both TCCON and EM27/SUN data.</p>
<p>A full rewrite of EGI, <a href="https://github.com/TCCON/egi-rs">EGI-RS</a> is in progress.
This is intended to be easier to maintain and modular, allowing smaller parts of the
GGG workflow to be run independently with EGI-RS automation as needed.
EGI-RS <em>does</em> use the programs provided by GGG-RS, and in fact relies on several of them
to simplify switching between TCCON and EM27/SUN configurations.
Throughout this section, the EM27/SUN standard use sections will be referring to the EGI-RS
use.
Those still using the original EGI should be aware that while the <em>role</em> of each program
in the EM27/SUN post processing is the same as its original Fortran predecessor, the
specifics of how it is run may differ.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="collate_tccon_results"><a class="header" href="#collate_tccon_results">collate_tccon_results</a></h1>
<h2 id="purpose"><a class="header" href="#purpose">Purpose</a></h2>
<p><code>collate_tccon_results</code> combines output from the various <code>.col</code> files in a GGG run directory with ancillary data from the runlog and <code>.ray</code> file into a single file.
It also computed retrieved quantities from the <code>.col</code> files if needed.
Which <code>.col</code> files are read is determined by a <code>multiggg.sh</code> file, which is expected to contain calls to <code>gfit</code> (one per line) for each window processed.
An example of a the first few lines of a <code>multiggg.sh</code> file is:</p>
<pre><code class="language-text">/home/user/ggg/bin/gfit luft_6146.pa_ggg_benchmark.ggg&gt;/dev/null
/home/user/ggg/bin/gfit hf_4038.pa_ggg_benchmark.ggg&gt;/dev/null
/home/user/ggg/bin/gfit h2o_4565.pa_ggg_benchmark.ggg&gt;/dev/null
/home/user/ggg/bin/gfit h2o_4570.pa_ggg_benchmark.ggg&gt;/dev/null
</code></pre>
<p>Unlike the standard <code>collate_results</code>, <code>collate_tccon_results</code> does not rely on the ZPD times of spectra to determine whether successive spectra in the runlog
(from different detectors) should have their outputs grouped into a single line in the output file.
Instead, it uses the spectrum names.</p>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<p>The most common way to run this is from inside a GGG run directory (i.e., a directory containing the <code>multiggg.sh</code>, <code>.ggg</code>, <code>.mav</code>, and <code>.ray</code> files created by <code>gsetup</code>).
In that case, you will call it with a single positional argument, <code>v</code> to create a file containg vertical column densities or <code>t</code> to create one containing VMR scale factors.
The output file will have the same name as the runlog pointed to in the <code>.ggg</code> and <code>.col</code> files, with the extension <code>.vsw</code> or <code>.tsw</code>:</p>
<pre><code class="language-bash">$GGGPATH/bin/collate_tccon_results v
</code></pre>
<p>If you need to run this program from outside of a GGG run directory, you can use the <code>--multiggg-file</code> option to point to the <code>multiggg.sh</code> file to read windows from.
In this case, the output will be written to the same directory as the <code>multiggg.sh</code> file:</p>
<pre><code class="language-bash">$GGGPATH/bin/collate_tccon_results --multiggg-file /data/ggg/xx20250101_20250301/multiggg.sh
</code></pre>
<p>This program relies on being able to determine a "primary" detector in order to know which spectra represent a new observation.
If you have a nonstandard setup that does not use "a" as the character in the spectrum name to represent the InGaAs detector, you can use
the <code>--primary-detector</code> option to specify a different character.
For example, if it should look for spectra with "g" as the detector indicator:</p>
<pre><code class="language-bash">$GGGPATH/bin/collate_tccon_results --primary-detector g v
</code></pre>
<h2 id="use-in-tccon-standard-processing"><a class="header" href="#use-in-tccon-standard-processing">Use in TCCON standard processing</a></h2>
<p>Most users will use this as part of running the <code>post_processing.sh</code> script to create the initial <code>.vsw</code> and <code>.tsw</code> files.
However, in any case, it will always be the first program run after GFIT as the other post processing programs need a post
processed file as input (i.e., they do not read from the <code>.col</code> files.)</p>
<h2 id="use-in-em27sun-standard-processing"><a class="header" href="#use-in-em27sun-standard-processing">Use in EM27/SUN standard processing</a></h2>
<p><code>collate_tccon_results</code> is used identically when processing EM27/SUN data as when processing TCCON data.
Unlike with the Fortran version of <code>collate_results</code>, it does not need adapted to account for the shorter time between successive observations.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="apply_tccon_airmass_correction"><a class="header" href="#apply_tccon_airmass_correction">apply_tccon_airmass_correction</a></h1>
<h2 id="purpose-1"><a class="header" href="#purpose-1">Purpose</a></h2>
<p><code>apply_tccon_airmass_correction</code> does two things:</p>
<ol>
<li>Converts gas column densities (in molecules per area) to column averages by dividing
by the O2 column and multiplying by the mean O2 atmospheric dry mole fraction.</li>
<li>Applies a solar zenith angle-dependent correction to those column averages that require
it, as defined by a configuration file.</li>
</ol>
<p>This can operate either on individual windows' column densities or on column densities calculated
by averaging together all the windows for a given gas.
The former is considered to be more accurate, as it allows for different airmass dependence per window
(which depends on the spectroscopy in that window), but the latter is preserved for backwards compatibility.</p>
<h2 id="examples-1"><a class="header" href="#examples-1">Examples</a></h2>
<p>This program requires two arguments: a path to a file defining the airmass corrections and
a path to either a <code>.vsw</code> file (created by <code>collate_tccon_results</code>) or <code>.vav</code> file (created
by <code>average_results</code>):</p>
<pre><code class="language-bash">$GGGPATH/bin/apply_tccon_airmass_correction CORRECTION_FILE VSW_OR_VAV_FILE
</code></pre>
<p>The <code>CORRECTION_FILE</code> will usually be one of those supplied with GGG, in the <code>$GGGPATH/tccon</code> subdirectory.
See <a href="postproc//postproc/corrections/airmass_correction_file.html">the configuration section</a> for the details of this
file's format if you need to modify one or create your own.</p>
<h2 id="use-in-tccon-standard-processing-1"><a class="header" href="#use-in-tccon-standard-processing-1">Use in TCCON standard processing</a></h2>
<p>For TCCON standard processing, the <code>CORRECTION_FILE</code> <em>must</em> be <code>$GGGPATH/tccon/corrections_airmass_preavg.dat</code>,
as these are the airmass correction factors derived for the required TCCON data version.
It must be run on the <code>vsw</code> file output by <code>collate_tccon_results</code>, as the TCCON standard processing uses per-window
airmass corrections.
This is automatically configured in the <code>post_processing.sh</code> file, therefore standard users should rely on the
<code>post_processing.sh</code> script to run the required post processing steps in the correct order.</p>
<h2 id="use-in-em27sun-standard-processing-1"><a class="header" href="#use-in-em27sun-standard-processing-1">Use in EM27/SUN standard processing</a></h2>
<p>As of GGG2020, EM27/SUNs still use per-gas airmass corrections, rather than per-window.
Therefore, this must be run on the <code>.vav</code> file output by <code>average_results</code> using the EM27/SUN-specific
airmass corrections included with EGI-RS.
If using EGI-RS correctly, it will automatically create a <code>post_processing.sh</code> file with the correct
post processing order for an EM27/SUN, so normal users should rely on that.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="airmass-correction-file-format"><a class="header" href="#airmass-correction-file-format">Airmass correction file format</a></h1>
<p>For backwards compatibility, this file is in the typical GGG input file format
of a line specifying the "shape" of the file, one or more header rows, then
tabular data.
These files come in two forms.
The first defines airmass corrections for each window, and includes not only
the magnitude of the correction, but two additional parameters that adjust the
form of the equation used for the correction.</p>
<h2 id="per-window-format"><a class="header" href="#per-window-format">Per-window format</a></h2>
<p>The GGG2020 TCCON standard file in this format is as follows:</p>
<pre><code class="language-text">15 5
2017-02-16  GCT
2015-08-11  DW
2019-01-14  JLL
2020-12-04  JLL: extrapolated to Xluft = 0.999
2021-02-22  JLL: fit for mid-trop PT = 310 K
2021-07-15  JLL: uncertainties added from 2-sigma std dev of bootstrapped PT = 310 K fits
Contains airmass-dependent correction factors to be applied to the
column-averaged mole fractions. These are determined offline from the
symmetric component of the diurnal variation using derive_airmass_correction.
The ADCF_Err should be the 1-sigma standard deviations which represent day-to-
day variability. This vastly overestimates the uncertainty in the average
value, however the standard error underestimates the uncertainty.
g and p are the zero-SZA and exponent in the ADCF form.
 Gas         ADCF      ADCF_Err  g    p
"xco2_6220"  -0.00903  0.00025   15   4
"xco2_6339"  -0.00512  0.00025   45   5
"xlco2_4852"  0.00008  0.00018  -45   1
"xwco2_6073" -0.00235  0.00016  -45   1
"xwco2_6500" -0.00970  0.00026   45   5
"xch4_5938"  -0.00971  0.00046   25   4
"xch4_6002"  -0.00602  0.00053  -5    2
"xch4_6076"  -0.00594  0.00044   15   3
"xn2o_4395"   0.00523  0.00054  -5    2
"xn2o_4430"   0.00426  0.00042   13   3
"xn2o_4719"  -0.00267  0.00056  -15   2
"xco_4233"    0.00000  0.00000   13   3
"xco_4290"    0.00000  0.00000   13   3
"xluft_6146"  0.00053  0.00017  -45   1
</code></pre>
<p>The components are as follows:</p>
<ul>
<li>The first line specifies the number of header lines and the number of data columns.
This must be two integers separated by whitespace.
The number of header lines includes this line and the column headers.</li>
<li>The next <code>nhead-2</code> lines (line numbers 2 to 14 in this case) are free format; these are
skipped by the program. You can see in the example that thse are used to record the
history of the file and notes about the content of the file.</li>
<li>The last header line (line number 15 in this case) gives the column names; it must include
the five columns shown here.</li>
</ul>
<div id="admonition-info" class="admonition admonish-info" role="note" aria-labelledby="admonition-info-title">
<div class="admonition-title">
<div id="admonition-info-title">
<p>Info</p>
</div>
<a class="admonition-anchor-link" href="postproc/corrections/airmass_correction_file.html#admonition-info"></a>
</div>
<div>
<p>A common error is to add lines to the header without updating the number of header lines
on the first line.
If you get an error running <code>apply_tccon_airmass_correction</code> after editing the correction
file's header, double check that you also updated the number of header lines!</p>
</div>
</div>
<p>The data are as follows:</p>
<ul>
<li>"Gas" is the Xgas window name that the correction defined on this line applies to.
It must be a string that matches a non-error column in the input <code>.vsw</code> file with "x" prepended.
As this is read in as <a href="https://docs.oracle.com/cd/E19957-01/805-4939/6j4m0vnc5/index.html">list directed format data</a>,
it is recommended to quote the strings.</li>
<li>"ADCF" is the airmass dependent correction factor, it determines the magnitude of the airmass correction.</li>
<li>"ADCF_Err" is the uncertainty on the ADCF.</li>
<li>"g" and "p" are parameters in the airmass correction equation.</li>
</ul>
<p>Deriving the correction parameters is a complicated process.
For details, along with the definition of the airmass correction equation, please see section 8.1 of the <a href="https://doi.org/10.5194/essd-16-2197-2024">GGG2020 paper</a>.</p>
<h2 id="per-gas-format"><a class="header" href="#per-gas-format">Per-gas format</a></h2>
<p>The second format of the airmass correction file is as follows:</p>
<pre><code class="language-text">13 3
2017-02-16  GCT
2015-08-11  DW
Contains airmass-dependent and airmass-independent (in situ)
correction factors to be applied to the column-averaged mole fractions.
The former (ADCF) is determined offline from the symmetric component
of the diurnal variation using derive_airmass_correction.
The ADCF_Err are the 1-sigma standard deviations which represent day-to-
day variability. This vastly overestimates the uncertainty in the average
value, however the standard error underestimates the uncertainty.
The latter (AICF) is determined offline by comparisons with in situ profiles.
AICF_Err (uncertainties) are 1-sigma standard deviations from the best fit.
 Gas      ADCF  ADCF_Err
"xco2"  -0.0049  0.0009
"xch4"  -0.0045  0.0005
"xn2o"   0.0133  0.0001
"xco"    0.0000  0.0001
"xh2o"  -0.0000  0.0001
"xluft"  0.0027  0.0005
</code></pre>
<p>This is a simplified version of the per-window format <a href="postproc/corrections/airmass_correction_file.html#per-window-format">above</a>.
As above, the first line defines the number of header lines and data columns.
This file must have three data columns: "Gas", "ADCF", and "ADCF_Err".
These have the same meanings as in the per-window format.
The "g" and "p" columns can be omitted, as shown here.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="apply_tccon_insitu_correction"><a class="header" href="#apply_tccon_insitu_correction">apply_tccon_insitu_correction</a></h1>
<h2 id="purpose-2"><a class="header" href="#purpose-2">Purpose</a></h2>
<p><code>apply_tccon_insitu_correction</code> has a single purpose, that is to apply a scalar divisor scale factor
to specific column-average quantities.
This is typically used to ensure that these quantities are tied to the same metrological scale as
comparable <em>in situ</em> data.</p>
<h2 id="examples-2"><a class="header" href="#examples-2">Examples</a></h2>
<p>This program requires two arguments: a path to a file defining the scaling corrections and
a path to either a <code>.vav.ada</code> file, created by <code>apply_tccon_airmass_correction</code>:</p>
<pre><code class="language-bash">$GGGPATH/bin/apply_tccon_insitu_correction CORRECTION_FILE VAV_ADA_FILE
</code></pre>
<p>The <code>CORRECTION_FILE</code> will usually be one of those supplied with GGG, in the <code>$GGGPATH/tccon</code> subdirectory.
See <a href="postproc//postproc/corrections/insitu_correction_file.html">the configuration section</a> for the details of this
file's format if you need to modify one or create your own.</p>
<h2 id="use-in-tccon-standard-processing-2"><a class="header" href="#use-in-tccon-standard-processing-2">Use in TCCON standard processing</a></h2>
<p>For TCCON standard processing, the <code>CORRECTION_FILE</code> <em>must</em> be <code>$GGGPATH/tccon/corrections_insitu_postavg.dat</code>,
as these are the <em>in situ</em> correction factors derived for the required TCCON data version.
It must be run on the <code>.vav.ada</code> file output by <code>apply_tccon_airmass_correction</code>.
This is automatically configured in the <code>post_processing.sh</code> file, therefore standard users should rely on the
<code>post_processing.sh</code> script to run the required post processing steps in the correct order.</p>
<h2 id="use-in-em27sun-standard-processing-2"><a class="header" href="#use-in-em27sun-standard-processing-2">Use in EM27/SUN standard processing</a></h2>
<p>EM27/SUNs have their own <em>in situ</em> correction factors.
These correction factors are provided with EGI-RS, and automatically added to the <code>$GGGPATH/tccon</code> directory
when running the <code>em27-init</code> program included with EGI-RS.
If using EGI-RS correctly, it will automatically create a <code>post_processing.sh</code> file with the correct
post processing order for an EM27/SUN, so normal users should rely on that.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="in-situ-correction-file-format"><a class="header" href="#in-situ-correction-file-format">In situ correction file format</a></h1>
<p>For backwards compatibility, this file is in the typical GGG input file format
of a line specifying the "shape" of the file, one or more header rows, then
tabular data.
The standard TCCON GGG2020 is show here as an example:</p>
<pre><code class="language-text">19 4
2017-02-16  GCT
2015-08-11  DW
2021-07-26  JLL
This file contains airmass-independent correction factors (AICFs) determined
offline by comparison against in situ data. CO2, wCO2, lCO2, CH4, and H2O use AICFs
determined as the weighted mean ratio of TCCON to in situ Xgas values. N2O
uses the ratio of TCCON to surface-derived in situ XN2O fit to a mid-tropospheric
potential temperature of 310 K, ensuring that it is fixed to the same temperature
as the ADCFs. CO, H2O, and Luft are not corrected.
For CO2, wCO2, lCO2, CH4, H2O, and CO the AICF_Err (uncertainties) are 2-sigma standard
deviations of bootstrapped mean ratios. For N2O, the error equals the fit vs. potential
temperature multiplied by twice the standard deviation of potential temperatures
experienced by the TCCON network.
The WMO_Scale column gives the WMO scale from the in situ data that the scale
factor ties to. There must be something in this column and must be quoted;
use "N/A" for gases with no WMO scaling. NB: although CO has no WMO scale (because it
is not scaled), the uncertainty was determined from the measurements on the WMO X2014A scale.
 Gas     AICF  AICF_Err  WMO_Scale
"xco2"   1.0101  0.0005  "WMO CO2 X2007"
"xwco2"  1.0008  0.0005  "WMO CO2 X2007"
"xlco2"  1.0014  0.0007  "WMO CO2 X2007"
"xch4"   1.0031  0.0014  "WMO CH4 X2004"
"xn2o"   0.9821  0.0098  "NOAA 2006A"
"xco"    1.0000  0.0526  "N/A"
"xh2o"   0.9883  0.0157  "ARM Radiosondes (Lamont+Darwin)"
"xluft"  1.0000  0.0000  "N/A"
</code></pre>
<p>The components are as follows:</p>
<ul>
<li>The first line specifies the number of header lines and the number of data columns.
This must be two integers separated by whitespace.
The number of header lines includes this line and the column headers.</li>
<li>The next <code>nhead-2</code> lines (line numbers 2 to 18 in this case) are free format; these are
skipped by the program. You can see in the example that these are used to record the
history of the file and notes about the content of the file.</li>
<li>The last header line (line number 19 in this case) gives the column names; it must include
the four columns shown here.</li>
</ul>
<div id="admonition-info" class="admonition admonish-info" role="note" aria-labelledby="admonition-info-title">
<div class="admonition-title">
<div id="admonition-info-title">
<p>Info</p>
</div>
<a class="admonition-anchor-link" href="postproc/corrections/insitu_correction_file.html#admonition-info"></a>
</div>
<div>
<p>A common error is to add lines to the header without updating the number of header lines
on the first line.
If you get an error running <code>apply_tccon_insitu_correction</code> after editing the correction
file's header, double check that you also updated the number of header lines!</p>
</div>
</div>
<p>The data are as follows:</p>
<ul>
<li>"Gas" refers to the column in the <code>.vav.ada</code> file that the correction applies to
(along with the associated error, i.e., "xco2" will apply to both the "xco2" and "xco2_error" columns).</li>
<li>"AICF" is the scaling factor; the Xgas and error will be divided by this.</li>
<li>"AICF_Err" is the uncertainty on the scaling factor.</li>
<li>"WMO_Scale" is the metrological scale or other reference to which the scale factor ties the
These must be quoted strings.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="add_nc_flags"><a class="header" href="#add_nc_flags">add_nc_flags</a></h1>
<h2 id="purpose-3"><a class="header" href="#purpose-3">Purpose</a></h2>
<p><code>add_nc_flags</code> is an additional program that can be used to add additional flags to a private netCDF file.
This is intended to <em>supplement</em> the default flagging done by <code>write_netcdf</code>, which reflects both the permitted
value ranges defined in your site's <code>??_qc.dat</code> and <code>??_manual_flagging.dat</code> files (found under <code>$GGGPATH/tccon</code>).
In particular, this is useful if you need to include more complex logic, such as only flagging based on a combination
of variables.</p>
<h2 id="examples-3"><a class="header" href="#examples-3">Examples</a></h2>
<h3 id="quick-flagging"><a class="header" href="#quick-flagging">Quick flagging</a></h3>
<p>The <code>quick</code> subcommand allows you to specify the filter criteria based on a single variable via the command line.
This first example will flag any data where the residual in the O2 window is above 0.5, and will modify the existing
netCDF file:</p>
<pre><code class="language-bash">$GGGPATH/bin/add_nc_flags quick \
  --in-place \
  --filter-var o2_7885_rmsocl \
  --greater-than 0.5 \
  --nc-file PRIVATE_NC_FILE
</code></pre>
<p>Note that we have separated the command into multiple lines solely for readability; you can write this as a single line.</p>
<p>If instead you did not want to modify the existing netCDF file, but instead create a copy, use the <code>--output</code> flag:</p>
<pre><code class="language-bash">$GGGPATH/bin/add_nc_flags quick \
  --output NEW_NC_FILE \
  --filter-var o2_7885_rmsocl \
  --greater-than 0.5 \
  --nc-file PRIVATE_NC_FILE
</code></pre>
<p>This will not create <code>NEW_NC_FILE</code> if no data needed to be flagged.
If you want to enforce that a new file is always created, add the <code>--always-copy</code> flag:</p>
<pre><code class="language-bash">$GGGPATH/bin/add_nc_flags quick \
  --output NEW_NC_FILE \
  --always-copy \
  --filter-var o2_7885_rmsocl \
  --greater-than 0.5 \
  --nc-file PRIVATE_NC_FILE
</code></pre>
<p>If you wanted to limit the flags to a specific time period, use <code>--time-less-than</code> and <code>--time-greater-than</code>.
Note that the values must be given in UTC:</p>
<pre><code class="language-bash">$GGGPATH/bin/add_nc_flags quick \
  --output NEW_NC_FILE \
  --filter-var o2_7885_rmsocl \
  --greater-than 0.5 \
  --time-greater-than 2025-04-01T12:00 \
  --time-less-than 2025-05-01 \
  --nc-file PRIVATE_NC_FILE
</code></pre>
<p>This will only apply flags data with a ZPD time greater than or equal to 12:00Z on 1 Apr 2025 and less than or equal to
00:00Z on 1 May 2025.
Note that in the less than argument we omit the hour and minute.</p>
<p>There are many more options, see the command line help for a full list.</p>
<h3 id="toml-based-flagging"><a class="header" href="#toml-based-flagging">TOML-based flagging</a></h3>
<p>For more complicated flagging, you can define your flagging criteria in a <a href="https://toml.io/en/">TOML file</a>.
You can create an example file with the <code>toml-template</code> subcommand:</p>
<pre><code class="language-bash">$GGGPATH/bin/add_nc_flags toml-template example.toml
</code></pre>
<p>This will create <code>example.toml</code> in the current directory.</p>
<p>Once you have defined your filters, you apply this file with the <code>toml</code> subcommand.
As with the <code>quick</code> subcommand, flags can be applied to the existing file:</p>
<pre><code class="language-bash">$GGGPATH/bin/add_nc_flags toml TOML_FILE --in-place --nc-file PRIVATE_NC_FILE
</code></pre>
<p>or to a copy of it:</p>
<pre><code class="language-bash">$GGGPATH/bin/add_nc_flags toml TOML_FILE --output NEW_NC_FILE --nc-file PRIVATE_NC_FILE
</code></pre>
<p>For details on the TOML file settings, see the <a href="postproc//postproc/add_nc_flags_toml.html">following section</a>.</p>
<h2 id="use-in-tccon-standard-processing-3"><a class="header" href="#use-in-tccon-standard-processing-3">Use in TCCON standard processing</a></h2>
<p>This program is not used by default in TCCON post processing.
(That is, it will not be included in the <code>post_processing.sh</code> script.)
Users are welcome to use it separately to flag out data with known problems from the private netCDF files before uploading to Caltech.</p>
<h2 id="use-in-em27sun-standard-processing-3"><a class="header" href="#use-in-em27sun-standard-processing-3">Use in EM27/SUN standard processing</a></h2>
<p>EGI-RS will include a line in the <code>post_processing.sh</code> script to run this program on the private netCDF file.
The intention is for users to add extra data checks to deal with EM27/SUN-specific issues that may affect the data.
Additionally, EGI-RS may add certain required filters in the future as the use of GGG for EM27/SUN retrievals matures.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="add_nc_flags-toml-filter-configuration"><a class="header" href="#add_nc_flags-toml-filter-configuration"><code>add_nc_flags</code> TOML filter configuration</a></h1>
<h2 id="filters-and-groups"><a class="header" href="#filters-and-groups">Filters and groups</a></h2>
<p>The TOML files used to define flags for <code>add_nc_flags</code> use the terms "group" and "filter" as follows:</p>
<ul>
<li>A "filter" defines an allowed range for a single variable.
It may specify and upper or lower limit, an allowed range, or an excluded range.</li>
<li>A "group" consists of one or more filters.</li>
</ul>
<p>An observation in the netCDF file will be flagged if any of the groups defined in the TOML file
indicate that it should be.
A group will indicate an observation should be flagged if all of the filters in that group indicate
it should be flagged.</p>
<p>The first example shows how you would define a TOML file that duplicates the filter we used
in the <a href="postproc//postproc/add_nc_flags.html#quick-flagging">quick filter example</a>:</p>
<pre><code class="language-toml">[[groups]]
[[groups.filters]]
filter_var = "o2_7885_rmsocl"
greater_than = 0.5
</code></pre>
<p>This defines a single check: if value of the <code>o2_7885_rmsocl</code> variable in the netCDF file is
<code>&gt;= 0.5</code>, that observation will be flagged.</p>
<p>Now suppose that we wanted to flag observations only if <code>o2_7885_rmsocl &gt;= 0.5</code> <em>and</em> <code>o2_7885_cl &lt; 0.05</code>,
perhaps to remove observations where our instrument was not tracking the sun well.
To do this, we add a second filter to this group like so:</p>
<pre><code class="language-toml">[[groups]]
[[groups.filters]]
filter_var = "o2_7885_rmsocl"
greater_than = 0.5

[[groups.filters]]
filter_var = "o2_7885_cl"
less_than = 0.05
</code></pre>
<p>Now, because these both come under the same <code>[[group]]</code> heading, observations will only be flagged if both conditions are true.</p>
<p>What if we wanted to do an or, that is, filter if either one of two (or more) conditions are true?
That requires multiple groups:</p>
<pre><code class="language-toml">[[groups]]
[[groups.filters]]
filter_var = "o2_7885_rmsocl"
greater_than = 0.5

[[groups]]
[[groups.filters]]
filter_var = "o2_7885_sg"
greater_than = 0.1
</code></pre>
<p>Because each filter comes after its own <code>[[group]]</code> header, they fall in separate groups.
If either group has all its filters return true, then the observation will be flagged.
In this case, that means that an observation with <code>o2_7885_rmsocl &gt;= 0.5</code> <em>or</em> <code>o2_7885_sg &lt;= 0.1</code>
will be flagged.</p>
<p>What if we wanted to flag an observation with an <code>o2_7885_sg</code> value too far from zero in either direction?
We can do that with the <code>value_mode</code> key, like so:</p>
<pre><code class="language-toml">[[groups]]
[[groups.filters]]
filter_var = "o2_7885_sg"
greater_than = 0.1
less_than = -0.1
value_mode = "outside"
</code></pre>
<p>This will cause an observation to be flagged if <code>o2_7885_sg &lt;= -0.1</code> or <code>o2_7885_sg &gt;= +0.1</code>.
If we do not specify <code>value_mode</code>, the default is "inside", which in this case would flag
if <code>-0.1 &lt;= o2_7885_sg &lt;= +0.1</code>.</p>
<h2 id="limiting-to-times"><a class="header" href="#limiting-to-times">Limiting to times</a></h2>
<p>The TOML file allows you to specify that it should only apply to a specific time frame with the <code>[timespan]</code> section.
This allows three keys: <code>time_less_than</code>, <code>time_greater_than</code>, and <code>time_mode</code>.
For example, perhaps you wish to filter on continuum level only between two times when you know your instrument
was not tracking the sun correctly.
You could do so with:</p>
<pre><code class="language-toml">[[groups]]
[[groups.filters]]
filter_var = "o2_7885_cl"
less_than = 0.05

[timespan]
time_greater_than = "2025-01-01T00:00:00"
time_less_than = "2025-05-01T00:00:00"
</code></pre>
<p>Note that the times must be in UTC and given in the full "yyyy-mm-ddTHH:MM:SS" format; unlike the <code>quick</code> command line
option, you cannot truncate these to just "yyyy-mm-dd" or "yyyy-mm-ddTHH:MM".
<code>time_mode</code>, similar to <code>value_mode</code> in the filters, allows you to only flag observations outside of the given time
range, rather than inside it:</p>
<pre><code class="language-toml">[[groups]]
[[groups.filters]]
filter_var = "o2_7885_cl"
less_than = 0.05

[timespan]
time_greater_than = "2025-01-01T00:00:00"
time_less_than = "2025-05-01T00:00:00"
time_mode = "outside"
</code></pre>
<p>This will apply the filter to any data before 1 Jan 2025 and after 1 May 2025, whereas the previous example would
apply to data between those two dates.</p>
<h2 id="changing-the-flag"><a class="header" href="#changing-the-flag">Changing the flag</a></h2>
<h3 id="flag-value"><a class="header" href="#flag-value">Flag value</a></h3>
<p>By default, when <code>add_nc_flags</code> applies a flag, it does so by adding 9000 to the value of the <code>flag</code> variable for
that observation.
This preserves any of the standard flags from variables defined in the <code>??_qc.dat</code> file.
By TCCON convention, a 9 in the thousands place of the flag represents a generic "other" manual flag.
If you wish to use one of the other values to distinguish the nature of the problem, you can define a <code>[flags]</code> section:</p>
<pre><code class="language-toml">[flags]
flag = 8

# The configuration must always include a [[groups]] entry with at least one filter.
[[groups]]
[[groups.filters]]
filter_var = "o2_7885_cl"
less_than = 0.05
</code></pre>
<p>This will add 8000 to the flag instead of 9000; i.e., it will put an 8 in the thousands place.</p>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="postproc/add_nc_flags_toml.html#admonition-note"></a>
</div>
<div>
<p>The value of <code>flag</code> must be between 1 and 9, since it must fit into the thousands place.
Some values have existing meanings. Currently these are defined in
<a href="https://github.com/TCCON/py_tccon_netcdf/blob/main/write_tccon_netcdf/release_flag_definitions.json">a JSON file bundled with the private netCDF writer</a>.
When the private netCDF writer is incorporated into GGG-RS, that definition file will be moved into this repository.</p>
</div>
</div>
<h3 id="behavior-for-existing-flags"><a class="header" href="#behavior-for-existing-flags">Behavior for existing flags</a></h3>
<p>We can also adjust how <code>add_nc_flags</code> behaves if there is already a value in the thousands place.
By default, it will error.
We can change this by setting the <code>existing_flags</code> key in the <code>[flags]</code> section.
For example, to keep existing values in the thousands place of the flag (which would be set by either
the time periods defined in your <code>$GGGPATH/tccon/??_manual_flagging.dat</code> or a previous run of <code>add_nc_flags</code>):</p>
<pre><code class="language-toml">[flags]
flag = 8
existing_flags = "skip"

# The configuration must always include a [[groups]] entry with at least one filter.
[[groups]]
[[groups.filters]]
filter_var = "o2_7885_cl"
less_than = 0.05
</code></pre>
<p>The possible (case insensitive) values for <code>existing_flags</code> are:</p>
<ul>
<li><code>"error"</code> (default) - error if any of the observations to be flagged already have a non-zero value in the flag's thousands place</li>
<li><code>"skip"</code> - if an observation to be flagged already has a value in the flag's thousands place, leave the existing value.</li>
<li><code>"skipeq"</code> - if the value in the thousands place is 0 is will be replaced, otherwise <code>add_nc_flags</code> will error unless the value
matches what it would insert.</li>
<li><code>"overwrite"</code> - replace any existing value in the flag's thousands place.</li>
</ul>
<h3 id="flag-type"><a class="header" href="#flag-type">Flag type</a></h3>
<p>The default behavior, as mentioned <a href="postproc/add_nc_flags_toml.html#flag-value">above</a>, is to modify the thousands place of the flag for observations to be flagged.
<code>add_nc_flags</code> can also edit the ten thousands place, which is used for release flags.
To do so, set <code>flag_type</code> to <code>"release"</code> in the <code>[flags]</code> section:</p>
<pre><code class="language-toml">[flags]
flag = 8
flag_type = "release"

# The configuration must always include a [[groups]] entry with at least one filter.
[[groups]]
[[groups.filters]]
filter_var = "o2_7885_cl"
less_than = 0.05
</code></pre>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="postproc/add_nc_flags_toml.html#admonition-warning"></a>
</div>
<div>
<p>Release flags are intended to be set by Caltech personnel based on input from the reviewers during data QA/QC.
If you use <code>add_nc_flags</code> to set release flags in other circumstances, this can lead to significant confusion
when trying to establish the provenance of certain flags.
Please do not use <code>flag_type = "release"</code> unless you have received specific guidance to do so!</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="write_public_netcdf"><a class="header" href="#write_public_netcdf">write_public_netcdf</a></h1>
<h2 id="purpose-4"><a class="header" href="#purpose-4">Purpose</a></h2>
<p><code>write_public_netcdf</code> converts the private (a.k.a. engineering) netCDF files into smaller, more user-friendly, files distributed to most TCCON users.
This includes:</p>
<ul>
<li>limiting the variables to the most useful,</li>
<li>removing <code>flag != 0</code> data,</li>
<li>optionally limiting the data in the file based on the desired data latency, and</li>
<li>expanding the averaging kernels and prior profiles to be one-per-spectrum.</li>
</ul>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="postproc/write_public_netcdf.html#admonition-warning"></a>
</div>
<div>
<p>If you previously used the Python netCDF writer, you may be used to it defaulting to respecting a data latency (a.k.a. release lag)
defined in a site information JSON file.
This version of the netCDF writer defaults to no data latency; that is, it assumes that you want to include all data from the given
private file in the new public file.
See the examples below for how to apply a data latency to withhold the newest data from the public file.</p>
</div>
</div>
<h2 id="examples-4"><a class="header" href="#examples-4">Examples</a></h2>
<p>The simplest use will convert the <code>PRIVATE_NC_FILE</code> into a public format file.
This assumes that the <code>PRIVATE_NC_FILE</code> filename begins with the two-character site ID for your site.
The public file will be in the same directory as the private file, and its name will reflect the site ID and the date range of the <code>flag == 0</code> data:</p>
<pre><code class="language-bash">$GGGPATH/bin/write_public_netcdf PRIVATE_NC_FILE
</code></pre>
<p>To avoid renaming the public file to match the dates of <code>flag == 0</code> data, use the <code>--no-rename-by-dates</code> flag.
This will replace "private" in the extension with "public", so if <code>PRIVATE_NC_FILE</code> was <code>pa_ggg_benchmark.private.qc.nc</code>, the public file would be named <code>pa_ggg_benchmark.public.qc.nc</code>:</p>
<pre><code class="language-bash">$GGGPATH/bin/write_public_netcdf --no-rename-by-dates PRIVATE_NC_FILE
</code></pre>
<p>Both of the above examples will use the standard TCCON configuration for which variables to copy.
To use the extended TCCON configuration (which will include gases from the secondary detector), add the <code>--extended</code> flag:</p>
<pre><code class="language-bash">$GGGPATH/bin/write_public_netcdf --extended PRIVATE_NC_FILE
</code></pre>
<p>If you need to customize which variables are copied, you must create your own configuration TOML file and pass it to the <code>--config</code> option:</p>
<pre><code class="language-bash">$GGGPATH/bin/write_public_netcdf --config CUSTOM_CONFIG.toml PRIVATE_NC_FILE
</code></pre>
<p>For information on the configuration file format, see <a href="postproc//write_public_netcdf/configuration.html">its section of this book</a>.</p>
<p>To withhold the newest data from the public file, you can use the <code>--data-latency-date</code> or <code>--data-latency-days</code> options
to specify either a number of days in the past from today or a specific date after which to withhold data.</p>
<pre><code class="language-bash">$GGGPATH/bin/write_public_netcdf --data-latency-date 2025-01-01 PRIVATE_NC_FILE
$GGGPATH/bin/write_public_netcdf --data-latency-days 120 PRIVATE_NC_FILE
</code></pre>
<p>The first one will withhold data with a ZPD time after midnight UTC on 1 Jan 2025 from the public file.
The second will withhold data with a ZPD time after midnight UTC 120 days ago from the public file:
if run on 1 May 2025 (UTC), this would also have 1 Jan 2025 as the cutoff date.</p>
<h2 id="use-in-tccon-standard-processing-4"><a class="header" href="#use-in-tccon-standard-processing-4">Use in TCCON standard processing</a></h2>
<p>Individual TCCON sites <strong>should not need to use this program</strong> under normal circumstances.
This program will be run at Caltech on the concatenated and quality controlled private netCDF files, and the resulting public netCDF files will be made available through <a href="https://tccondata.org">tccondata.org</a>.
This function is provided as part of GGG-RS for sites that have, for example, low latency or custom products delivered to specific users as non-standard TCCON data, but wish to provide the data in the user-friendly public format instead of the much more intimidating private file format.
Presently, you will need to follow the instructions <a href="https://tccon-wiki.caltech.edu/Main/GeneratingPublicFilesGGG2020">on the TCCON wiki</a> to generate a concatenated and quality controlled private file, then run this program on the resulting file.
Note that access permission is required for this wiki page to track who is generating GGG public files.</p>
<h2 id="use-in-em27sun-standard-processing-4"><a class="header" href="#use-in-em27sun-standard-processing-4">Use in EM27/SUN standard processing</a></h2>
<p>As there is not yet an equivalent of the TCCON data pipeline at Caltech for EM27/SUN data processed with GGG, operators will likely want to use this program to generate public files of their data for upload to whatever data repository they host from.
Presently, you will need to follow the instructions <a href="https://tccon-wiki.caltech.edu/Main/GeneratingPublicFilesGGG2020">on the TCCON wiki</a> to generate a concatenated and quality controlled private file, then run this program on the resulting file.
Note that access permission is required for this wiki page to track who is generating GGG public files.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuration"><a class="header" href="#configuration">Configuration</a></h1>
<p>The public netCDF writer must strike a balance between being strict enough to ensure that the required variable for standard TCCON usage are included in normal operation, but also be flexible enough to allow non-standard usage.
To enable more flexible use, the writer by default requires the standard TCCON variables be present, but can be configured to change the required variables.</p>
<p>The configuration file uses <a href="https://toml.io/en/">TOML format</a>.
The configuration file can be broadly broken down into five sections:</p>
<ul>
<li>auxiliary variables,</li>
<li>derived variables,</li>
<li>Xgas variable sets,</li>
<li>Xgas discovery, and</li>
<li>default settings.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="auxiliary-variables"><a class="header" href="#auxiliary-variables">Auxiliary variables</a></h1>
<p>Auxiliary variables are those which are not directly related to one of the target Xgases but which provide useful information about the observations. Common examples are time, latitude, longitude, solar zenith angle, etc.
These are defined in the <code>aux</code> section of the TOML file as an <a href="https://toml.io/en/v1.0.0#array-of-tables">array of tables</a>.</p>
<p>The simplest way to define an auxiliary variable to copy is to give the name of the private variable in the netCDF file and what value to use as the long name:</p>
<pre><code class="language-toml">[[aux]]
private_name = "solzen"
long_name = "solar zenith angle"
</code></pre>
<p>This will copy the variable <code>solzen</code> from the private netCDF file along with all its attributes <em>except</em> <code>standard_name</code> and <code>precision</code>, add the <code>long_name</code> attribute, and put the variable's data (subsetting to <code>flag == 0</code> data) into the public file as <code>solzen</code>.
Note that the <code>long_name</code> value should follow the <a href="https://cfconventions.org/cf-conventions/cf-conventions.html#long-name">CF conventions meaning</a>.
We prefer <code>long_name</code> over <code>standard_name</code> because the <a href="https://cfconventions.org/Data/cf-standard-names/current/build/cf-standard-name-table.html">available standard names</a> do not adequately describe remotely sensed quantities.</p>
<p>If instead you wanted to rename the variable in the public file, you can add the <code>public_name</code> field:</p>
<pre><code class="language-toml">[[aux]]
private_name = "solzen"
public_name = "solar_zenith_angle"
long_name = "solar zenith angle"
</code></pre>
<p>This would rename the variable to <code>solar_zenith_angle</code> in the public file, but otherwise behave identically to above.</p>
<p>You can also control the attributes copied through two more fields, <code>attr_overrides</code> and <code>attr_to_remove</code>.
<code>attr_overrides</code> is a TOML table of attibute names and values that will be added to the public variable.
If an attribute is listed in the private file with the same name as an override, the override value in the config takes precedence.
The latter is an array of attribute names to skip copying if present.
(If one of these attributes is not present in the private file, nothing happens.)
An example:</p>
<pre><code class="language-toml">[[aux]]
private_name = "day"
long_name = "day of year"
attr_overrides = {units = "Julian day", description = "1-based day of year"}
attr_to_remove = ["vmin", "vmax"]
</code></pre>
<p>This will add or replace the attributes <code>units</code> and <code>description</code> in the public file with those given here, and ensure that the <code>vmin</code> and <code>vmax</code> attributes are not copied.
Take note, specifying <code>attr_to_remove</code> overrides the default list of <code>standard_name</code> and <code>precision</code>; this can be useful if you want to retain those (you can do so by specifying <code>attr_to_remove = []</code>), but if you want to exclude them, you must add them to your list.</p>
<p>Finally, by default any auxiliary variable listed here must be found in the private netCDF file, or the public writer stops with an error.
To change this behavior so that a variable is optional, add the <code>required = false</code> field to an aux variable:</p>
<pre><code class="language-toml">[[aux]]
private_name = "day"
long_name = "day of year"
required = false
</code></pre>
<p>Each auxiliary variable to copy will have its own <code>[[aux]]</code> section, for example:</p>
<pre><code class="language-toml">[[aux]]
private_name = "time"
long_name = "zero path difference UTC time"

[[aux]]
private_name = "year"
long_name = "year"

[[aux]]
private_name = "day"
long_name = "day of year"
attr_overrides = {units = "Julian day", description = "1-based day of year"}

[[aux]]
private_name = "solzen"
long_name = "solar zenith angle"
</code></pre>
<p>By default, any of the standard TCCON auxiliary variables not listed will be added.
See the <a href="postproc/write_public_netcdf//write_public_netcdf/defaults.html">Defaults</a> section for how to modify that behavior.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="computed-variables"><a class="header" href="#computed-variables">Computed variables</a></h1>
<p>Computed variables are similar to auxiliary variables in that they are not directly associated with a single Xgas.
Unlike auxiliary variables, these cannot be simply copied from the private netCDF file.
Instead, they must be computed from one or more private variables.
Because of that, there are a specific set of these variables pre-defined by the public writer.
Currently only one computed variable type exists, "prior_source".
You can specify it in the configuration as follows:</p>
<pre><code class="language-toml">[[computed]]
type = "prior_source"
</code></pre>
<p>By default, this creates a public variable named "apriori_data_source".
You can change this with the <code>public_name</code> field, e.g.:</p>
<pre><code class="language-toml">[[computed]]
type = "prior_source"
public_name = "geos_source_set"
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="xgas-discovery"><a class="header" href="#xgas-discovery">Xgas discovery</a></h1>
<p>Usually we do not want to specify every single Xgas to copy; instead, we want the writer to scan the private file to identify Xgases and copy everything that matches.
This both saves a lot of tedious typing in the configuration and minimizes the possibilty of copy-paste errors.</p>
<h2 id="rules"><a class="header" href="#rules">Rules</a></h2>
<p>The first part of the discovery section is a list of rules for how to find Xgas variables.
These come in two variants:</p>
<ol>
<li>Suffix rules: these look for variables that start with something starting with an Xgas-like pattern
and ending in the given suffix. The full regex is <code>^x([a-z][a-z0-9]*)_{suffix}$</code>, where <code>{suffix}</code> is the provided suffix.
Note that the suffix is passed through [<code>regex::escape</code>] to ensure that any special characters are escaped; it will only
be treated as a literal.</li>
<li>Regex rules: these allow you to specify a regular expression to match variables names. The regex <em>must</em> include a named
capture group with the name "gas" that extracts the physical gas abbreviation (i.e., the <code>gas</code> value in an <code>Xgas</code> entry).
This looks like <code>(?&lt;gas&gt;...)</code> where the <code>...</code> is the regular subexpression that matches that part of the string.</li>
</ol>
<p>By default, the configuration will add a single regex rule that matches the pattern <code>^x(?&lt;gas&gt;[a-z][a-z0-9]*)$</code>.
You can disable this by setting <code>xgas_rules = false</code> in the <a href="postproc/write_public_netcdf//write_public_netcdf/defaults.html"><code>[defaults]</code></a> section of the config.
This rule is designed to match basic Xgas variables, e.g., "xch4", "xn2o", etc.</p>
<p>An example of a regular expression rule that uses the default ways to infer its ancillary variables is:</p>
<pre><code class="language-toml">[[discovery.rule]]
regex = '^column_average_(?&lt;gas&gt;\w+)$'
</code></pre>
<p>Two things to note are:</p>
<ol>
<li>The regular expression is inside single quotes; this is how TOML specifies literal strings and it the
most convenient way to write regexes that include backslashes. (Otherwise TOML itself will intepret them
as escape characters.)</li>
<li>The regex includes <code>^</code> and <code>$</code> to anchor the start and end of the pattern. In most cases, you will probably
want to do so as well to avoid matching arbitrary parts of variable names.</li>
</ol>
<p>An example of a suffix rule that also indicates that variables matching this rule should not include averaging kernels or the traceability scale is:</p>
<pre><code class="language-toml">[[discovery.rule]]
suffix = "mir"
ak = { type = "omit" }
traceability_scale = { type = "omit" }
</code></pre>
<p>Note that the suffix rule contains a "suffix" key, while the regular expression rule has a "regex" key - this is how they are distinguished.
Also note that rules are checked in order, and a variable is added following the first rule that matches.
This means that if a variable matches multiple rules, then its ancillary variables will be set up following the first rule that matched.</p>
<h2 id="attributes"><a class="header" href="#attributes">Attributes</a></h2>
<p>Discovery rules can specify the fields <code>xgas_attr_overrides</code>, <code>xgas_error_attr_overrides</code>, <code>prior_profile_attr_overrides</code>,
<code>prior_xgas_attr_overrides</code>, and <code>ak_attr_overrides</code> to set attributes on their respective variables.
These should be used for attributes that will be the same for <em>all</em> the variables of that type created by this rule.
For example, to add a cautionary note about experimental data to our previous mid-IR discovery rule:</p>
<pre><code class="language-toml">[[discovery.rule]]
suffix = "mir"
xgas_attr_overrides = { note = "Experimental data, use with caution!" }
ak = { type = "omit" }
traceability_scale = { type = "omit" }
</code></pre>
<h2 id="ancillary-variables"><a class="header" href="#ancillary-variables">Ancillary variables</a></h2>
<p>The rules also include default settings for the prior profile, prior column average, averaging kernel (and its slant Xgas bins), and the traceability scale.
These can be specified the same way as described <a href="postproc/write_public_netcdf//write_public_netcdf/explicit_xgases.html#ancillary-variable-specifications">in the Xgases ancillary subsection</a>,
and the defaults are the same as well.
However only the <code>inferred</code> and <code>omit</code> types may be used, as <code>specified</code> does not make sense when a rule may apply to more than one Xgas.</p>
<h2 id="exclusions"><a class="header" href="#exclusions">Exclusions</a></h2>
<p>The second part of the discovery section are lists of gases or variables to exclude.
The first option is <code>excluded_xgas_variables</code>.
If a variable's private file name matches one of the names in that list, it will not be copied even if it matches one of the rules.
The other option is <code>excluded_gases</code>, which matches not the variable name, but the physical gas.
The easiest way to explain this is to consider the standard TCCON configuration:</p>
<pre><code class="language-toml">[discovery]
excluded_xgas_variables = ["xo2"]
excluded_gases = ["th2o", "fco2", "zco2"]
</code></pre>
<p><code>excluded_xgas_variables</code> specifically excludes the "xo2" variable; this would match the default regex rule meant to capture Xgases measured on the primary detector, but we don't want to include it because it is not useful for data users.
However, O2 measured on a silicon detector may be useful, so we do not want to exclude all O2 variables.
<code>excluded_gases</code> lists three gases that we want to exclude no matter what detector they are retrieved from.
"fco2" and "zco2" are diagnostic windows (for channelling and zero-level offset, respectively) and so will be included once for each detector.
"th2o" is temperature sensitive water, which is generally confusing for the average user, so we want to ensure that it is also excluded from every detector.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="explicitly-specified-xgases"><a class="header" href="#explicitly-specified-xgases">Explicitly specified Xgases</a></h1>
<p>This section allows you to list specific Xgas variables to copy, along with some or all of the ancillary variables needed to properly interpret them.
Usually, you will not specify each Xgas by hand, but instead will use the <a href="postproc/write_public_netcdf//write_public_netcdf/xgas_discovery.html">discovery</a> capability of the writer to automatically find each Xgas to copy.
However, variables explicitly listed in this section take precedence over those found by the discovery rules.
This leads to two cases where you might specify an Xgas in this section:</p>
<ol>
<li>The Xgas does not follow the common naming convention, thus making it difficult to discover with simple rules, or difficult
to map from the Xgas variable to the ancillary variable.</li>
<li>The Xgas needs a different way to handle one of its ancillary variables that the default discovery does.</li>
</ol>
<p>Each Xgas has the following options:</p>
<ul>
<li><code>xgas</code> (required): the variable name</li>
<li><code>gas</code> (required): the physical gas name, e.g., "co2" for all the various CO2 variables (regular, <code>wco2</code>, and <code>lco2</code>).
This is used to match up to, e.g., the priors which do not distinguish between the different spectra windows.</li>
<li><code>gas_long</code> (optional): the full name of the gas instead of its abbreviation, e.g. "carbon dioxide" for CO2. If not given,
then the configuration will try to find the <code>gas</code> value in its <a href="postproc/write_public_netcdf//write_public_netcdf/gas_proper_names.html"><code>[gas_long_names]</code></a> section and use that,
falling back on the <code>gas</code> value if the gas is not defined in the gas long names section.</li>
<li><code>xgas_attr_overrides</code> (optional): a table of attribute values that can override existing attribute values on the private Xgas variable.</li>
<li><code>xgas_error_attr_overrides</code> (optional): a table of attribute values that can override existing attribute values on the private Xgas error variable.</li>
<li><code>prior_profile</code> (optional): how to copy the a priori profile.</li>
<li><code>prior_profile_attr_overrides</code> (optional): a table of attribute values that can override existing attribute values on the private prior profile variable.</li>
<li><code>prior_xgas</code> (optional): how to copy the a priori column average.</li>
<li><code>prior_xgas_attr_overrides</code> (optional): a table of attribute values that can override existing attribute values on the private prior Xgas variable.</li>
<li><code>ak</code> (optional): how to copy the averaging kernels.</li>
<li><code>ak_attr_overrides</code> (optional): a table of attribute values that can override existing attribute values on the private AK variable.</li>
<li><code>slant_bin</code> (optional): how to find the slant Xgas bin variable needed to expand the AKs.</li>
<li><code>traceability_scale</code> (optional): how to find the variable containing the WMO or analogous scale for this data.</li>
<li><code>required</code> (optional): this is <code>true</code> by default; set it to <code>false</code> if you want to copy this Xgas if present but it is not an error if it is missing.</li>
</ul>
<p><code>prior_profile</code>, <code>prior_xgas</code>, <code>ak</code>, <code>slant_bin</code>, and <code>traceability_scale</code> can all be defined following the syntax in the <a href="postproc/write_public_netcdf/explicit_xgases.html#ancillary-variable-specifications">ancillary variable specifications</a>.
Note that <code>slant_bin</code> is a special case in that it will only be used if the AKs are to be copied, but cannot be omitted in that case.</p>
<p>To illustrate the two main use cases for this section, here is an excerpt from the standard TCCON configuration:</p>
<pre><code class="language-toml">[[xgas]]
xgas = "xluft"
gas = "luft"
gas_long = "dry air"
prior_profile = { type = "omit" }
prior_xgas = { type = "omit" }
ak = { type = "omit" }

[[xgas]]
xgas = "xco2_x2019"
gas = "co2"
prior_profile = { type = "specified", only_if_first = true, private_name = "prior_1co2", public_name = "prior_co2" }
prior_xgas = { type = "specified", only_if_first = true, private_name = "prior_xco2_x2019", public_name = "prior_xco2" }
ak = { type = "specified", only_if_first = true, private_name = "ak_xco2" }
slant_bin = { type = "specified", private_name = "ak_slant_xco2_bin" }

[[xgas]]
xgas = "xwco2_x2019"
gas = "co2"
prior_profile = { type = "specified", only_if_first = true, private_name = "prior_1co2", public_name = "prior_co2" }
prior_xgas = { type = "specified", only_if_first = true, private_name = "prior_xwco2_x2019", public_name = "prior_xco2" }
ak = { type = "specified", only_if_first = true, private_name = "ak_xwco2" }
slant_bin = { type = "specified", private_name = "ak_slant_xwco2_bin" }
</code></pre>
<p>First we have <code>xluft</code>.
This variable would be discovered by the <a href="postproc/write_public_netcdf//write_public_netcdf/xgas_discovery.html#rules">default rule</a>; however, that rule will require prior information and AKs.
The prior information is not useful for Xluft, so we want to avoid copying that to reduce the number of extraneous variables, and there are no AKs for Xluft.
Thus we specify "omit" for each of these to tell the writer not to look for them.
We do not have to tell it to omit <code>slant_bin</code>, because omitting the AKs implicitly skips that, and <code>traceability_scale</code> can be left as normal because there is an "aicf_xluft_scale" variable in the private netCDF files.</p>
<p>Second we have <code>xco2_x2019</code> and <code>xwco2_x2019</code>.
(We have omitted the x2007 variables and <code>lco2_x2019</code> from the above example for brevity).
These would not be discovered by the <a href="postproc/write_public_netcdf//write_public_netcdf/xgas_discovery.html#rules">default rule</a>.
Further, the mapping to their prior and AK variables is unique: all the CO2 Xgas variables can share the prior profiles and column averages, and each "flavor" of CO2 (regular, wCO2, or lCO2) can use the same AKs whether it is on the X2007 or X2019 scale.
Thus, we not only define that these variables need copied, but that we want to rename the prior variables to just "prior_co2" and "prior_xco2" and only copy these the first time we find them.
We also ensure that the AKs and slant bins point to the correct variables.</p>
<p>If we wanted to set the <code>note</code> attribute of <code>xluft</code>, we could do that like so:</p>
<pre><code class="language-toml">[[xgas]]
xgas = "xluft"
gas = "luft"
gas_long = "dry air"
prior_profile = { type = "omit" }
prior_xgas = { type = "omit" }
ak = { type = "omit" }
xgas_attr_overrides = { note = "This is a diagnostic quantity" }
</code></pre>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="postproc/write_public_netcdf/explicit_xgases.html#admonition-note"></a>
</div>
<div>
<p>Not all attributes can be overridden, some are set internally by the netCDF writer to ensure consistency.
If an attribute is not getting the value you expect, first check the logging output from the netCDF writer
for a warning that a particular attribute cannot be set.</p>
</div>
</div>
<h2 id="ancillary-variable-specifications"><a class="header" href="#ancillary-variable-specifications">Ancillary variable specifications</a></h2>
<p>The ancillary variables (prior profile, prior Xgas, AK, slant bin, and traceability scale) can be defined as one of the following three types:</p>
<ul>
<li><code>inferred</code>: indicates that this ancillary variable must be included and should not conflict with any other
variable. The private and public variable names will be inferred from the Xgas and gas names. This type has
two options:
<ul>
<li><code>only_if_first</code>: a boolean (<code>false</code> by default) that when set to <code>true</code> will skip copying the relevant
variable if a variable with the same public name is already in the public file.
<strong>Note that the writer does not check that the existing variable's data are equal to what would be written for the new variable!</strong></li>
<li><code>required</code>: a boolean (<code>true</code> by default) that when set to <code>false</code> allows this variable to be missing
from the private file. This is intended for <a href="postproc/write_public_netcdf//write_public_netcdf/xgas_discovery.html#rules">Xgas discovery rules</a>
more than explicit Xgas definitions.</li>
</ul>
</li>
<li><code>specified</code>: allows you to specify exactly which variable to copy with the <code>private_name</code> field. You can also
give the <code>public_name</code> field to indicate what the variable name in the output file should be; if that is omitted,
then the public variable will have the same name as the private variable. It is an error if the public variable
already exists. The also allows the <code>only_if_first</code> field, which behaves how it does for the <code>inferred</code> type.</li>
<li><code>omit</code>: indicates that this variable should not be copied.</li>
</ul>
<p>In the following example, the prior Xgas field shows the use of the <code>inferred</code> options, the prior profile field
shows the use of the <code>specified</code> options, and the AK field the use of <code>omit</code>.</p>
<pre><code class="language-toml">[[xgas]]
xgas = "xhcl"
gas = "hcl"
prior_xgas = { type = "inferred", only_if_first = true, required = false }
prior_profile = { type = "specified", only_if_first = true, private_name = "prior_1hcl", public_name = "prior_hcl" }
ak = { type = "omit" }
</code></pre>
<h2 id="ancillary-variable-name-inference"><a class="header" href="#ancillary-variable-name-inference">Ancillary variable name inference</a></h2>
<p>The writer uses the following rules when asked to infer ancillary variable names.
In these, <code>{xgas_var}</code> indicates the Xgas variable name and <code>{gas}</code> the physical gas name.</p>
<ul>
<li><code>prior_profile</code>: looks for a private variable named <code>prior_1{gas}</code> and writes to a variable named <code>prior_{gas}</code>.</li>
<li><code>prior_xgas</code>: looks for a private variable named <code>prior_{xgas_var}</code> and writes to the same variable.</li>
<li><code>ak</code>: looks for a private variable named <code>ak_{xgas_var}</code> and writes to the same variable.</li>
<li><code>slant_bin</code>: looks for a private variable named <code>ak_slant_{xgas_var}_bin</code>. This is not written, it is only used to expand
the AKs to one-per-spectrum.</li>
<li><code>traceability_scale</code>: looks for a private variable named <code>aicf_{xgas_var}_scale</code>. The result is always written to the
<code>wmo_or_analogous_scale</code> attribute of the Xgas variable; that cannot be altered by this configuration.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gas-proper-names"><a class="header" href="#gas-proper-names">Gas proper names</a></h1>
<p>Ideally, all Xgases should include their proper name in the <code>long_name</code> attribute, rather than just its abbreviation.
This section allows you to map the formula (e.g., "co2") to the proper name (e.g., "carbon dioxide"), e.g.:</p>
<pre><code class="language-toml">[gas_long_names]
co2 = "carbon dioxide"
ch4 = "methane"
co = "carbon monoxide"
</code></pre>
<p>Note that the keys are the gases, not Xgases.
A default list is included if not turned off in the <a href="postproc/write_public_netcdf//write_public_netcdf/defaults.html"><code>[Defaults]</code></a> section.
See the source code for <a href="https://github.com/TCCON/ggg-rs/blob/main/src/bin/write_public_netcdf/constants.rs"><code>DEFAULT_GAS_LONG_NAMES</code></a> for the current list.
You can override any of those without turning off the defaults; e.g., setting <code>h2o = "dihydrogen monoxide"</code> in this section will replace the default of "water".</p>
<p>Of course, when <a href="postproc/write_public_netcdf//write_public_netcdf/explicit_xgases.html">explicitly defining an Xgas to copy</a>, you can write in the proper name as the <code>gas_long</code> value.
The <code>[gas_long_names]</code> section is most useful for automatically discovered Xgases, but it can also be useful when defining multiple Xgas variables that refer to the same physical gas, as the <a href="https://github.com/TCCON/ggg-rs/blob/main/src/bin/write_public_netcdf/tccon_configs/standard.toml">standard TCCON configuration</a> does with CO2.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="global-attributes"><a class="header" href="#global-attributes">Global attributes</a></h1>
<p>What global attributes (i.e., attributes from the root group of the netCDF file) to copy to the public file are defined by the <code>[global_attributes]</code> section.
This section contains two lists of strings:</p>
<ul>
<li><code>must_copy</code> lists the names of attributes that must be available in the private netCDF file, or an error is raised.</li>
<li><code>copy_if_present</code> lists the names of attributes to copy if available in the private netCDF file, but to not raise an error for if missing.</li>
</ul>
<p>An abbreviated example from the TCCON standard configuration is:</p>
<pre><code class="language-toml">[global_attributes]
must_copy = [
    "source",
    "description",
    "file_creation",
]
copy_if_present = [
    "long_name",
    "location",
]
</code></pre>
<p>At present, there is no way to manipulate attributes' values during the copying process, nor add arbitrary attributes.
In general, attributes should be added to the private netCDF file, then copied to the public file.
This ensures that attributes are consistent between the two files.
However, in the future we may add the ability to define some special cases.</p>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="postproc/write_public_netcdf/global_attributes.html#admonition-warning"></a>
</div>
<div>
<p>The <code>history</code> attribute is a special case, it will always be created or appended to following the
<a href="http://cfconventions.org/Data/cf-conventions/cf-conventions-1.12/cf-conventions.html#description-of-file-contents">CF conventions</a>,
no matter what the configuration says.
To avoid conflicts with this built in behavior, do not specify <code>history</code> as an attribute to copy in the configuration file.</p>
</div>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="including-other-configurations"><a class="header" href="#including-other-configurations">Including other configurations</a></h1>
<p>The public netCDF writer configuration can extend other configuration files.
The intended use is to define a base configuration with a set of variables that should always be included,
and extend that for different specialize use cases.
The TCCON standard configurations use this to reuse the standard configuration (including all of the auxiliary variables,
normal computer variables, and Xgas values from the InGaAs detector) in the extended configuration (which adds the
InSb or Si Xgas values).</p>
<p>To use another configuration file, use the <code>include</code> key:</p>
<pre><code class="language-toml #notest">include = ["base_config.toml"]
</code></pre>
<p>This is a list, so you can include multiple files:</p>
<pre><code class="language-toml #notest">include = ["base_config.toml", "extra_aux.toml"]
</code></pre>
<div id="admonition-info" class="admonition admonish-info" role="note" aria-labelledby="admonition-info-title">
<div class="admonition-title">
<div id="admonition-info-title">
<p>Info</p>
</div>
<a class="admonition-anchor-link" href="postproc/write_public_netcdf/includes.html#admonition-info"></a>
</div>
<div>
<p>Currently, when giving relative paths as the values for <code>include</code> as done here,
they are interpreted as relative to the current working directory.
However, you should not rely on that behavior - the intention is to adjust this
so that relative paths are interpreted as relative to the configuration file
in which they appear.
If you have a global set of configuration files that use <code>include</code>, for now,
it is best to use absolute paths in their respective <code>include</code> sections.</p>
</div>
</div>
<h2 id="how-configurations-are-combined"><a class="header" href="#how-configurations-are-combined">How configurations are combined</a></h2>
<p>Internally, <code>write_public_netcdf</code> uses the <code>figment</code> crate to combine the configurations.
Specifically, it uses the <a href="https://docs.rs/figment/latest/figment/struct.Figment.html#conflict-resolution">"adjoin" conflict resolution strategy</a>.
This means that lists (like the explicit Xgas definitions) from each configuration will be concatenated,
and scalar values will be taken from the first configuration that defines them.
(The order in which the configurations are parsed is defined <a href="postproc/write_public_netcdf/includes.html#order-of-inclusion">next</a>).</p>
<h2 id="order-of-inclusion"><a class="header" href="#order-of-inclusion">Order of inclusion</a></h2>
<p>The <code>include</code> key is recursive, so if <code>file1.toml</code> includes <code>file2.toml</code>, and
<code>file2.toml</code> includes <code>file3.toml</code>, then <code>file1.toml</code> will include the combination
of <code>file2.toml</code> and <code>file3.toml</code>.
When files include more than one other file, the algorithm does a "depth-first" ordering.
That is, if our top-level configuration has:</p>
<pre><code class="language-toml #notest"># top.toml
include = ["middle1.toml", "middle2.toml"]
</code></pre>
<p><code>middle1.toml</code> has:</p>
<pre><code class="language-toml #notest"># middle1.toml
include = ["bottom1a.toml", "bottom1b.toml"]
</code></pre>
<p>and <code>middle2.toml</code> has:</p>
<pre><code class="language-toml #notest"># middle2.toml
include = ["bottom2a.toml", "bottom2b.toml"]
</code></pre>
<p>then the order in which the files are added to the configuration is:</p>
<ul>
<li><code>top.toml</code></li>
<li><code>middle1.toml</code></li>
<li><code>bottom1a.toml</code></li>
<li><code>bottom1b.toml</code></li>
<li><code>middle2.toml</code></li>
<li><code>bottom2a.toml</code></li>
<li><code>bottom2b.toml</code></li>
</ul>
<p>In other words, coupled with the <a href="postproc/write_public_netcdf/includes.html#how-configurations-are-combined">"adjoin" behavior used</a>,
this ensures that the inclusion behavior is as you expect.
Settings in <code>top.toml</code> take precedence, then <em>all</em> settings in <code>middle1.toml</code> (whether they
are defined in <code>middle1.toml</code> itself or one of its included files), and then <code>middle2.toml</code>
(and its included files) comes last.</p>
<div id="admonition-warning" class="admonition admonish-warning" role="note" aria-labelledby="admonition-warning-title">
<div class="admonition-title">
<div id="admonition-warning-title">
<p>Warning</p>
</div>
<a class="admonition-anchor-link" href="postproc/write_public_netcdf/includes.html#admonition-warning"></a>
</div>
<div>
<p>Although you <em>can</em> create complex hierarchies of configurations as shown in this example,
doing so is generally not a good idea.
The more complicated you try to make the set of included files, the more likely you are
to end up with unexpected results - duplicated variables, wrong attributes, etc.
If you find yourself using more than one layer of inclusion, you may be better off
simply creating one large configuration file with the necessary parts of the other
files copied into it.</p>
</div>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="defaults"><a class="header" href="#defaults">Defaults</a></h1>
<p>Unlike other sections, the <code>[defaults]</code> section does not define variables to copy; instead, it modifies how the other sections are filled in.
If this section is omitted, then each of the other sections will add reasonable default values if omitted.
The following boolean options are available to change that behavior:</p>
<ul>
<li><code>disable_all</code>: setting this to <code>true</code> will ensure that no defaults are added in any section.</li>
<li><code>aux_vars</code>: setting this to <code>false</code> will prevent TCCON standard auxiliary variables from being added in the <code>aux</code> section.</li>
<li><code>gas_long_names</code>: setting this to <code>false</code> will prevent the standard mapping of chemical formulae to proper gas names being added to <code>[gas_long_names]</code>.</li>
<li><code>xgas_rules</code>: setting this to <code>false</code> will prevent the standard list of patterns to match when looking for Xgas variables from being added to <code>[discovery.rules]</code>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="debugging-tips"><a class="header" href="#debugging-tips">Debugging tips</a></h1>
<h2 id="configuration-parsing-errors"><a class="header" href="#configuration-parsing-errors">Configuration parsing errors</a></h2>
<p>If you are trying to use a custom configuration and the writer gives an error that it cannot "deserialize" the file,
that means that there is either a TOML syntax error or another typo.
To narrow down where the problem is, incrementally comment out parts of the configuration file and run the writer
with the <code>--check-config-only</code> flag.
When this can parse the configuration, it will print an internal representation of it to the screen.
Thus, when it starts working, whatever section you commented out is the likely culprit.</p>
<h2 id="unexpected-output-such-as-missing-or-duplicated-variables"><a class="header" href="#unexpected-output-such-as-missing-or-duplicated-variables">Unexpected output (such as missing or duplicated variables)</a></h2>
<p>If you seem to be missing variables in the output, have the same variable try to be written twice,
or other problems when using a custom configuration, first run the writer with the <code>--check-config-only</code>
flag and carefully examine the printed parsed version of the configuration.
This can help check if the configuration is being interpreted as you intended,
especially when using the <a href="postproc/write_public_netcdf//postproc/write_public_netcdf/includes.html">include feature</a></p>
<h2 id="checking-on-xgas-discovery"><a class="header" href="#checking-on-xgas-discovery">Checking on Xgas discovery</a></h2>
<p>If variables are not being copied correctly, increase the verbosity of <code>write_public_netcdf</code> by adding <code>-v</code>
or <code>-vv</code> to the command line. The first will activate debug output, which includes a lot of information about
Xgas discovery. <code>-vv</code> will also activate trace-level logging, which will output even more information about the
configuration as the program read it.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="site-metadata-file"><a class="header" href="#site-metadata-file">Site metadata file</a></h1>
<p><code>write_public_netcdf</code> can take the data latency/release lag from a TOML file that specifies site metadata.
There is an example for the standard TCCON sites <a href="https://github.com/TCCON/ggg-rs/blob/main/src/etc/site_info.toml">in the repo</a>.
This file must have top-level keys that match site two-character IDs, each containing a number of metadata values.
For example:</p>
<pre><code class="language-toml #notest">[pa]
long_name = "parkfalls01"
release_lag = 120
location = "Park Falls, Wisconsin, USA"
contact = "Paul Wennberg &lt;wennberg@gps.caltech.edu&gt;"
data_revision = "R1"
data_doi = "10.14291/tccon.ggg2014.parkfalls01.R1"
data_reference = "Wennberg, P. O., C. Roehl, D. Wunch, G. C. Toon, J.-F. Blavier, R. Washenfelder, G. Keppel-Aleks, N. Allen, J. Ayers. 2017. TCCON data from Park Falls, Wisconsin, USA, Release GGG2014R1. TCCON data archive, hosted by CaltechDATA, California Institute of Technology, Pasadena, CA, U.S.A. http://doi.org/10.14291/tccon.ggg2014.parkfalls01.R1"
site_reference = "Washenfelder, R. A., G. C. Toon, J.-F. L. Blavier, Z. Yang, N. T. Allen, P. O. Wennberg, S. A. Vay, D. M. Matross, and B. C. Daube (2006), Carbon dioxide column abundances at the Wisconsin Tall Tower site, Journal of Geophysical Research, 111(D22), 1-11, doi:10.1029/2006JD007154. Available from: https://www.agu.org/pubs/crossref/2006/2006JD007154.shtml"

[oc]
long_name = "lamont01"
release_lag = 120
location = "Lamont, Oklahoma, USA"
contact = "Paul Wennberg &lt;wennberg@gps.caltech.edu&gt;"
data_revision = "R1"
data_doi = "10.14291/tccon.ggg2014.lamont01.R1/1255070"
data_reference = "Wennberg, P. O., D. Wunch, C. Roehl, J.-F. Blavier, G. C. Toon, N. Allen, P. Dowell, K. Teske, C. Martin, J. Martin. 2017. TCCON data from Lamont, Oklahoma, USA, Release GGG2014R1. TCCON data archive, hosted by CaltechDATA, California Institute of Technology, Pasadena, CA, U.S.A. https://doi.org/10.14291/tccon.ggg2014.lamont01.R1/1255070"
site_reference = ""
</code></pre>
<p>Although the public netCDF writer only uses <code>release_lag</code>, each site <em>must</em> contain the following keys for this file to be valid:</p>
<ul>
<li><code>long_name</code>: the site's location readable name followed by a two-digit number indicating which instrument at that site this is.</li>
<li><code>release_lag</code>: an integer &gt;= 0 specifying how many days after acquisition data should be kept private.
TCCON sites are not permitted to set this &gt;366, as data delivery to the public archive within one year is a network requirement.</li>
<li><code>location</code>: a description of the location where the instrument resides.
This is usually "city, state/province/country", but can include things such as institution if desired.</li>
<li><code>contact</code>: the name and email address, formatted as <code>NAME &lt;EMAIL&gt;</code> of the person users should contact with questions or concern about this site's data.</li>
<li><code>data_revision</code>: an "R" followed by a number &gt;= 0 indicating which iteration of GGG2020 reprocessing this data represents.
This should be incremented whenever previously public data was reprocessed to fix an error.</li>
</ul>
<p>The following keys may be provided, but are not required:</p>
<ul>
<li><code>data_doi</code>: A digital object identifier that points to the public data for this site.
This should be included if possible; it is optional only so that public files can be created before the first time a DOI is minted.</li>
<li><code>data_reference</code>: A reference to a persistent repository where the data can be downloaded.
For TCCON sites, this will be CaltechData.
For other instruments, this may vary for now.</li>
<li><code>site_reference</code>: A reference to a publication describing the site location itself (as opposed to the data).</li>
</ul>
<p>TCCON sites can find the most up-to-date versions of their values for this metadata at https://tccondata.org/metadata/siteinfo/.
Other users should do their best to ensure that the above conventions are followed.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="other-utility-programs"><a class="header" href="#other-utility-programs">Other utility programs</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bin2nc"><a class="header" href="#bin2nc">bin2nc</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="query_output"><a class="header" href="#query_output">query_output</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="strip_header"><a class="header" href="#strip_header">strip_header</a></h1>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
