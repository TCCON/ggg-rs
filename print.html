<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>GGG-RS User Guide</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">GGG-RS User Guide</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="overview"><a class="header" href="#overview">Overview</a></h1>
<p>GGG-RS is an extension to <a href="https://github.com/TCCON/GGG">the GGG retrieval</a> that provides updated version of several of the post-processing programs.
The long term intention is to also make this a library of functions useful for working with GGG-related files.</p>
<h2 id="installation"><a class="header" href="#installation">Installation</a></h2>
<p>At present, installing GGG-RS requires that you be able to build it from source.
This requires, at a minimum, a <a href="https://rustup.rs/">Rust toolchain</a> installed.
If you wish to compile the programs that work with netCDF files, you will also need either</p>
<ul>
<li>one of the <code>micromamba</code>, <code>mamba</code>, or <code>conda</code> package managers, or</li>
<li>the <code>cmake</code> build tool.</li>
</ul>
<p>These are necessary to install or build the netCDF and HDF5 C libraries.
Detailed instructions and installation options are provided in the <a href="https://github.com/TCCON/ggg-rs">README</a>.</p>
<h2 id="documentation"><a class="header" href="#documentation">Documentation</a></h2>
<p>This book primarily focues on the command line programs provided by GGG-RS.
As the library is made available, the APIs will be documented through <a href="https://docs.rs/">docs.rs</a> (for the Rust library) and <code>readthedocs.io</code> (for the Python library).</p>
<p>Each command line program will provide help when given the <code>-h</code> or <code>--help</code> flags.
That help should be your first resource to understand how the programs work, as it will be the most up-to-date.
The chapters in this book go into more detail about advanced usage of the programs.
If you find something in this book that is out of date or unclear, please <a href="https://github.com/TCCON/ggg-rs/issues">open an issue</a> with the <code>documentation</code> tag.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="write_public_netcdf"><a class="header" href="#write_public_netcdf">write_public_netcdf</a></h1>
<h2 id="basic-usage"><a class="header" href="#basic-usage">Basic usage</a></h2>
<p><code>write_public_netcdf</code> converts the private (a.k.a. engineering) netCDF files into smaller, more user-friendly, files distributed to most TCCON users.
This includes:</p>
<ul>
<li>limiting the variables to the most useful,</li>
<li>removing <code>flag != 0</code> data,</li>
<li>limiting the data in the file based on the desired data latency, and</li>
<li>expanding the averaging kernels and prior profiles to be one-per-spectrum.</li>
</ul>
<p>In the simplest use, running <code>write_public_netcdf PRIVATE_NC_FILE</code>, where <code>PRIVATE_NC_FILE</code> is a path to the private file you wish to convert, is all that is required.
For other options, use the <code>--help</code> flag.
If you require a custom configuration for what variables to copy, see the <a href="/write_public_netcdf/configuration.html">Configuration</a> section.</p>
<h3 id="use-in-tccon-standard-processing"><a class="header" href="#use-in-tccon-standard-processing">Use in TCCON standard processing</a></h3>
<p>Individual TCCON sites <strong>should not need to use this program</strong> under normal circumstances.
This program will be run at Caltech on the concatenated and quality controlled private netCDF files, and the resulting public netCDF files will be made available through <a href="https://tccondata.org">tccondata.org</a>.
This function is provided as part of GGG-RS for sites that have, for example, low latency or custom products delivered to specific users as non-standard TCCON data, but wish to provide the data in the user-friendly public format instead of the much more intimidating private file format.
Presently, you will need to follow the instructions <a href="https://tccon-wiki.caltech.edu/Main/GeneratingPublicFilesGGG2020">on the TCCON wiki</a> to generate a concatenated and quality controlled private file, then run this program on the resulting file.
Note that access permission is required for this wiki page to track who is generating GGG public files.</p>
<h3 id="use-in-em27sun-standard-processing"><a class="header" href="#use-in-em27sun-standard-processing">Use in EM27/SUN standard processing</a></h3>
<p>As there is not yet an equivalent of the TCCON data pipeline at Caltech for EM27/SUN data processed with GGG, operators will likely want to use this program to generate public files of their data for upload to whatever data repository they host from.
Presently, you will need to follow the instructions <a href="https://tccon-wiki.caltech.edu/Main/GeneratingPublicFilesGGG2020">on the TCCON wiki</a> to generate a concatenated and quality controlled private file, then run this program on the resulting file.
Note that access permission is required for this wiki page to track who is generating GGG public files.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuration"><a class="header" href="#configuration">Configuration</a></h1>
<p>The public netCDF writer must strike a balance between being strict enough to ensure that the required variable for standard TCCON usage are included in normal operation, but also be flexible enough to allow non-standard usage.
To enable more flexible use, the writer by default requires the standard TCCON variables be present, but can be configured to change the required variables.</p>
<p>The configuration file uses <a href="https://toml.io/en/">TOML format</a>.
The configuration file can be broadly broken down into five sections:</p>
<ul>
<li>auxiliary variables,</li>
<li>derived variables,</li>
<li>Xgas variable sets,</li>
<li>Xgas discovery, and</li>
<li>default settings.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="auxiliary-variables"><a class="header" href="#auxiliary-variables">Auxiliary variables</a></h1>
<p>Auxiliary variables are those which are not directly related to one of the target Xgases but which provide useful information about the observations. Common examples are time, latitude, longitude, solar zenith angle, etc.
These are defined in the <code>aux</code> section of the TOML file as an <a href="https://toml.io/en/v1.0.0#array-of-tables">array of tables</a>.</p>
<p>The simplest way to define an auxiliary variable to copy is to give the name of the private variable in the netCDF file and what value to use as the long name:</p>
<pre><code class="language-toml">[[aux]]
private_name = "solzen"
long_name = "solar zenith angle"
</code></pre>
<p>This will copy the variable <code>solzen</code> from the private netCDF file along with all its attributes <em>except</em> <code>standard_name</code> and <code>precision</code>, add the <code>long_name</code> attribute, and put the variable's data (subsetting to <code>flag == 0</code> data) into the public file as <code>solzen</code>.
Note that the <code>long_name</code> value should follow the <a href="https://cfconventions.org/cf-conventions/cf-conventions.html#long-name">CF conventions meaning</a>.
We prefer <code>long_name</code> over <code>standard_name</code> because the <a href="https://cfconventions.org/Data/cf-standard-names/current/build/cf-standard-name-table.html">available standard names</a> do not adequately describe remotely sensed quantities.</p>
<p>If instead you wanted to rename the variable in the public file, you can add the <code>public_name</code> field:</p>
<pre><code class="language-toml">[[aux]]
private_name = "solzen"
public_name = "solar_zenith_angle"
long_name = "solar zenith angle"
</code></pre>
<p>This would rename the variable to <code>solar_zenith_angle</code> in the public file, but otherwise behave identically to above.</p>
<p>You can also control the attributes copied through two more fields, <code>attr_overrides</code> and <code>attr_to_remove</code>.
<code>attr_overrides</code> is a TOML table of attibute names and values that will be added to the public variable.
If an attribute is listed in the private file with the same name as an override, the override value in the config takes precedence.
The latter is an array of attribute names to skip copying if present.
(If one of these attributes is not present in the private file, nothing happens.)
An example:</p>
<pre><code class="language-toml">[[aux]]
private_name = "day"
long_name = "day of year"
attr_overrides = {units = "Julian day", description = "1-based day of year"}
attr_to_remove = ["vmin", "vmax"]
</code></pre>
<p>This will add or replace the attributes <code>units</code> and <code>description</code> in the public file with those given here, and ensure that the <code>vmin</code> and <code>vmax</code> attributes are not copied.
Take note, specifying <code>attr_to_remove</code> overrides the default list of <code>standard_name</code> and <code>precision</code>; this can be useful if you want to retain those (you can do so by specifying <code>attr_to_remove = []</code>), but if you want to exclude them, you must add them to your list.</p>
<p>Finally, by default any auxiliary variable listed here must be found in the private netCDF file, or the public writer stops with an error.
To change this behavior so that a variable is optional, add the <code>required = false</code> field to an aux variable:</p>
<pre><code class="language-toml">[[aux]]
private_name = "day"
long_name = "day of year"
required = false
</code></pre>
<p>Each auxiliary variable to copy will have its own <code>[[aux]]</code> section, for example:</p>
<pre><code class="language-toml">[[aux]]
private_name = "time"
long_name = "zero path difference UTC time"

[[aux]]
private_name = "year"
long_name = "year"

[[aux]]
private_name = "day"
long_name = "day of year"
attr_overrides = {units = "Julian day", description = "1-based day of year"}

[[aux]]
private_name = "solzen"
long_name = "solar zenith angle"
</code></pre>
<p>By default, any of the standard TCCON auxiliary variables not listed will be added.
See the <a href="write_public_netcdf//write_public_netcdf/defaults.html">Defaults</a> section for how to modify that behavior.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="computed-variables"><a class="header" href="#computed-variables">Computed variables</a></h1>
<p>Computed variables are similar to auxiliary variables in that they are not directly associated with a single Xgas.
Unlike auxiliary variables, these cannot be simply copied from the private netCDF file.
Instead, they must be computed from one or more private variables.
Because of that, there are a specific set of these variables pre-defined by the public writer.
Currently only one computed variable type exists, "prior_source".
You can specify it in the configuration as follows:</p>
<pre><code class="language-toml">[[computed]]
type = "prior_source"
</code></pre>
<p>By default, this creates a public variable named "apriori_data_source".
You can change this with the <code>public_name</code> field, e.g.:</p>
<pre><code class="language-toml">[[computed]]
type = "prior_source"
public_name = "geos_source_set"
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="xgas-discovery"><a class="header" href="#xgas-discovery">Xgas discovery</a></h1>
<p>Usually we do not want to specify every single Xgas to copy; instead, we want the writer to scan the private file to identify Xgases and copy everything that matches.
This both saves a lot of tedious typing in the configuration and minimizes the possibilty of copy-paste errors.</p>
<h2 id="rules"><a class="header" href="#rules">Rules</a></h2>
<p>The first part of the discovery section is a list of rules for how to find Xgas variables.
These come in two variants:</p>
<ol>
<li>Suffix rules: these look for variables that start with something starting with an Xgas-like pattern
and ending in the given suffix. The full regex is <code>^x([a-z][a-z0-9]*)_\w+_{suffix}$</code>, where <code>{suffix}</code> is the provided suffix.
Note that the suffix is passed through [<code>regex::escape</code>] to ensure that any special characters are escaped; it will only
be treated as a literal.</li>
<li>Regex rules: these allow you to specify a regular expression to match variables names. The regex <em>must</em> include a named
capture group with the name "gas" that extracts the physical gas abbreviation (i.e., the <code>gas</code> value in an <code>Xgas</code> entry).
This looks like <code>(?&lt;gas&gt;...)</code> where the <code>...</code> is the regular subexpression that matches that part of the string.</li>
</ol>
<p>By default, the configuration will add a single regex rule that matches the pattern <code>^x(?&lt;gas&gt;[a-z][a-z0-9]*)$</code>.
You can disable this by setting <code>xgas_rules = false</code> in the <a href="write_public_netcdf//write_public_netcdf/defaults.html"><code>[defaults]</code></a> section of the config.
This rule is designed to match basic Xgas variables, e.g., "xch4", "xn2o", etc.</p>
<p>The rules also include default settings for the prior profile, prior column average, averaging kernel (and its slant Xgas bins), and the traceability scale.
These can be specified the same way as described <a href="write_public_netcdf//write_public_netcdf/explicit_xgases.html#ancillary-variable-specifications">in the Xgases ancillary subsection</a>,
and the defaults are the same as well.</p>
<p>An example of a regular expression rule that uses the default ways to infer its ancillary variables is:</p>
<pre><code class="language-toml">[[discovery.rule]]
regex = '^column_average_(?&lt;gas&gt;\w+)$'
</code></pre>
<p>Two things to note are:</p>
<ol>
<li>The regular expression is inside single quotes; this is how TOML specifies literal strings and it the
most convenient way to write regexes that include backslashes. (Otherwise TOML itself will intepret them
as escape characters.)</li>
<li>The regex includes <code>^</code> and <code>$</code> to anchor the start and end of the pattern. In most cases, you will probably
want to do so as well to avoid matching arbitrary parts of variable names.</li>
</ol>
<p>An example of a suffix rule that also indicates that variables matching this rule should not include averaging kernels or the traceability scale is:</p>
<pre><code class="language-toml">[[discovery.rule]]
suffix = "mir"
ak = { type = "omit" }
traceability_scale = { type = "omit" }
</code></pre>
<p>Note that the suffix rule contains a "suffix" key, while the regular expression rule has a "regex" key - this is how they are distinguished.
Also note that rules are checked in order, and a variable is added following the first rule that matches.
This means that if a variable matches multiple rules, then its ancillary variables will be set up following the first rule that matched.</p>
<h2 id="exclusions"><a class="header" href="#exclusions">Exclusions</a></h2>
<p>The second part of the discovery section are lists of gases or variables to exclude.
The first option is <code>excluded_xgas_variables</code>.
If a variable's private file name matches one of the names in that list, it will not be copied even if it matches one of the rules.
The other option is <code>excluded_gases</code>, which matches not the variable name, but the physical gas.
The easiest way to explain this is to consider the standard TCCON configuration:</p>
<pre><code class="language-toml">excluded_xgas_variables = ["xo2"]
excluded_gases = ["th2o", "fco2", "zco2"]
</code></pre>
<p><code>excluded_xgas_variables</code> specifically excludes the "xo2" variable; this would match the default regex rule meant to capture Xgases measured on the primary detector, but we don't want to include it because it is not useful for data users.
However, O2 measured on a silicon detector may be useful, so we do not want to exclude all O2 variables.
<code>excluded_gases</code> lists three gases that we want to exclude no matter what detector they are retrieved from.
"fco2" and "zco2" are diagnostic windows (for channelling and zero-level offset, respectively) and so will be included once for each detector.
"th2o" is temperature sensitive water, which is generally confusing for the average user, so we want to ensure that it is also excluded from every detector.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="explicitly-specified-xgases"><a class="header" href="#explicitly-specified-xgases">Explicitly specified Xgases</a></h1>
<p>This section allows you to list specific Xgas variables to copy, along with some or all of the ancillary variables needed to properly interpret them.
Usually, you will not specify each Xgas by hand, but instead will use the <a href="write_public_netcdf//write_public_netcdf/xgas_discovery.html">discovery</a> capability of the writer to automatically find each Xgas to copy.
However, variables explicitly listed in this section take precedence over those found by the discovery rules.
This leads to two cases where you might specify an Xgas in this section:</p>
<ol>
<li>The Xgas does not follow the common naming convention, thus making it difficult to discover with simple rules, or difficult
to map from the Xgas variable to the ancillary variable.</li>
<li>The Xgas needs a different way to handle one of its ancillary variables that the default discovery does.</li>
</ol>
<p>Each Xgas has the following options:</p>
<ul>
<li><code>xgas</code> (required): the variable name</li>
<li><code>gas</code> (required): the physical gas name, e.g., "co2" for all the various CO2 variables (regular, <code>wco2</code>, and <code>lco2</code>).
This is used to match up to, e.g., the priors which do not distinguish between the different spectra windows.</li>
<li><code>gas_long</code> (optional): the full name of the gas instead of its abbreviation, e.g. "carbon dioxide" for CO2. If not given,
then the configuration will try to find the <code>gas</code> value in its <a href="write_public_netcdf//write_public_netcdf/gas_proper_names.html"><code>[gas_long_names]</code></a> section and use that,
falling back on the <code>gas</code> value if the gas is not defined in the gas long names section.</li>
<li><code>prior_profile</code> (optional): how to copy the a priori profile.</li>
<li><code>prior_xgas</code> (optional): how to copy the a priori column average.</li>
<li><code>ak</code> (optional): how to copy the averaging kernels.</li>
<li><code>slant_bin</code> (optional): how to find the slant Xgas bin variable needed to expand the AKs.</li>
<li><code>traceability_scale</code> (optional): how to find the variable containing the WMO or analogous scale for this data.</li>
</ul>
<p><code>prior_profile</code>, <code>prior_xgas</code>, <code>ak</code>, <code>slant_bin</code>, and <code>traceability_scale</code> can all be defined following the syntax in the <a href="write_public_netcdf/explicit_xgases.html#ancillary-variable-specifications">ancillary variable specifications</a>.
Note that <code>slant_bin</code> is a special case in that it will only be used if the AKs are to be copied, but cannot be omitted in that case.</p>
<p>To illustrate the two main use cases for this section, here is an excerpt from the standard TCCON configuration:</p>
<pre><code class="language-toml">[[xgas]]
xgas = "xluft"
gas = "luft"
gas_long = "dry air"
prior_profile = { type = "omit" }
prior_xgas = { type = "omit" }
ak = { type = "omit" }

[[xgas]]
xgas = "xco2_x2019"
gas = "co2"
prior_profile = { type = "specified_if_first", private_name = "prior_1co2", public_name = "prior_co2" }
prior_xgas = { type = "specified_if_first", private_name = "prior_xco2_x2019", public_name = "prior_xco2" }
ak = { type = "specified_if_first", private_name = "ak_xco2" }
slant_bin = { type = "specified", private_name = "ak_slant_xco2_bin" }

[[xgas]]
xgas = "xwco2_x2019"
gas = "co2"
prior_profile = { type = "specified_if_first", private_name = "prior_1co2", public_name = "prior_co2" }
prior_xgas = { type = "specified_if_first", private_name = "prior_xwco2_x2019", public_name = "prior_xco2" }
ak = { type = "specified_if_first", private_name = "ak_xwco2" }
slant_bin = { type = "specified", private_name = "ak_slant_xwco2_bin" }
</code></pre>
<p>First we have <code>xluft</code>.
This variable would be discovered by the <a href="write_public_netcdf//write_public_netcdf/xgas_discovery.html#rules">default rule</a>; however, that rule will require prior information and AKs.
The prior information is not useful for Xluft, so we want to avoid copying that to reduce the number of extraneous variables, and there are no AKs for Xluft.
Thus we specify "omit" for each of these to tell the writer not to look for them.
We do not have to tell it to omit <code>slant_bin</code>, because omitting the AKs implicitly skips that, and <code>traceability_scale</code> can be left as normal because there is an "aicf_xluft_scale" variable in the private netCDF files.</p>
<p>Second we have <code>xco2_x2019</code> and <code>xwco2_x2019</code>.
(We have omitted the x2007 variables and <code>lco2_x2019</code> from the above example for brevity).
These would not be discovered by the <a href="write_public_netcdf//write_public_netcdf/xgas_discovery.html#rules">default rule</a>.
Further, the mapping to their prior and AK variables is unique: all the CO2 Xgas variables can share the prior profiles and column averages, and each "flavor" of CO2 (regular, wCO2, or lCO2) can use the same AKs whether it is on the X2007 or X2019 scale.
Thus, we not only define that these variables need copied, but that we want to rename the prior variables to just "prior_co2" and "prior_xco2" and only copy these the first time we find them.
We also ensure that the AKs and slant bins point to the correct variables.</p>
<h2 id="ancillary-variable-specifications"><a class="header" href="#ancillary-variable-specifications">Ancillary variable specifications</a></h2>
<p>The ancillary variables (prior profile, prior Xgas, AK, slant bin, and traceability scale) can be defined as one of the following six types:</p>
<ul>
<li><code>inferred</code>: indicates that this ancillary variable must be included and should not conflict with any other
variable. The private and public variable names will be inferred from the Xgas and gas names.</li>
<li><code>inferred_if_first</code>: similar to <code>inferred</code>, except that it is not an error if the variable already exists
in the public file. This is meant to support cases like described for CO2 above, where multiple Xgases share
a single ancillary variable - as long as one Xgas copies it, the other Xgases do not need to.
<strong>Note that the writer does not check that the existing variable's data are equal to what would be written for the new variable!</strong></li>
<li><code>opt_inferred_if_first</code>: similar to <code>inferred_if_first</code>, except that if the private variable does not exist,
then this variable will be skipped instead of causing an error. This is intended for <a href="write_public_netcdf//write_public_netcdf/xgas_discovery.html#rules">Xgas discovery rules</a> more than explicit Xgas definitions.</li>
<li><code>specified</code>: allows you to specify exactly which variable to copy with the <code>private_name</code> field. You can also
give the <code>public_name</code> field to indicate what the variable name in the output file should be; if that is omitted,
then the public variable will have the same name as the private variable. It is an error if the public variable
already exists.</li>
<li><code>specified_if_first</code>: similar to <code>specified</code>, except that it is not an error if the public variable already exists.
(This is analogous to the relationship between <code>inferred</code> and <code>inferred_if_first</code>). This has the same <code>private_name</code>
and <code>public_name</code> fields as <code>specified</code>.</li>
<li><code>omit</code>: indicates that this variable should not be copied.</li>
</ul>
<h2 id="ancillary-variable-name-inference"><a class="header" href="#ancillary-variable-name-inference">Ancillary variable name inference</a></h2>
<p>The writer uses the following rules when asked to infer ancillary variable names.
In these, <code>{xgas_var}</code> indicates the Xgas variable name and <code>{gas}</code> the physical gas name.</p>
<ul>
<li><code>prior_profile</code>: looks for a private variable named <code>prior_1{gas}</code> and writes to a variable named <code>prior_{gas}</code>.</li>
<li><code>prior_xgas</code>: looks for a private variable named <code>prior_{xgas_var}</code> and writes to the same variable.</li>
<li><code>ak</code>: looks for a private variable named <code>ak_{xgas_var}</code> and writes to the same variable.</li>
<li><code>slant_bin</code>: looks for a private variable named <code>ak_slant_{xgas_var}_bin</code>. This is not written, it is only used to expand
the AKs to one-per-spectrum.</li>
<li><code>traceability_scale</code>: looks for a private variable named <code>aicf_{xgas_var}_scale</code>. The result is always written to the
<code>wmo_or_analogous_scale</code> attribute of the Xgas variable; that cannot be altered by this configuration.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gas-proper-names"><a class="header" href="#gas-proper-names">Gas proper names</a></h1>
<p>Ideally, all Xgases should include their proper name in the <code>long_name</code> attribute, rather than just its abbreviation.
This section allows you to map the formula (e.g., "co2") to the proper name (e.g., "carbon dioxide"), e.g.:</p>
<pre><code class="language-toml">[gas_long_names]
co2 = "carbon dioxide"
ch4 = "methane"
co = "carbon monoxide"
</code></pre>
<p>Note that the keys are the gases, not Xgases.
A default list is included if not turned off in the <a href="write_public_netcdf//write_public_netcdf/defaults.html"><code>[Defaults]</code></a> section.
See the source code for <a href="https://github.com/TCCON/ggg-rs/blob/main/src/bin/write_public_netcdf/constants.rs"><code>DEFAULT_GAS_LONG_NAMES</code></a> for the current list.
You can override any of those without turning off the defaults; e.g., setting <code>h2o = "dihydrogen monoxide"</code> in this section will replace the default of "water".</p>
<p>Of course, when <a href="write_public_netcdf//write_public_netcdf/explicit_xgases.html">explicitly defining an Xgas to copy</a>, you can write in the proper name as the <code>gas_long</code> value.
The <code>[gas_long_names]</code> section is most useful for automatically discovered Xgases, but it can also be useful when defining multiple Xgas variables that refer to the same physical gas, as the <a href="https://github.com/TCCON/ggg-rs/blob/main/src/bin/write_public_netcdf/tccon_configs/standard.toml">standard TCCON configuration</a> does with CO2.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="defaults"><a class="header" href="#defaults">Defaults</a></h1>
<p>Unlike other sections, the <code>[defaults]</code> section does not define variables to copy; instead, it modifies how the other sections are filled in.
If this section is omitted, then each of the other sections will add reasonable default values if omitted.
The following boolean options are available to change that behavior:</p>
<ul>
<li><code>disable_all</code>: setting this to <code>true</code> will ensure that no defaults are added in any section.</li>
<li><code>aux_vars</code>: setting this to <code>false</code> will prevent TCCON standard auxiliary variables from being added in the <code>aux</code> section.</li>
<li><code>gas_long_names</code>: setting this to <code>false</code> will prevent the standard mapping of chemical formulae to proper gas names being added to <code>[gas_long_names]</code>.</li>
<li><code>xgas_rules</code>: setting this to <code>false</code> will prevent the standard list of patterns to match when looking for Xgas variables from being added to <code>[discovery.rules]</code>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="debugging-tips"><a class="header" href="#debugging-tips">Debugging tips</a></h1>
<h2 id="checking-on-xgas-discovery"><a class="header" href="#checking-on-xgas-discovery">Checking on Xgas discovery</a></h2>
<p>If variables are not being copied correctly, increase the verbosity of <code>write_public_netcdf</code> by adding <code>-v</code>
or <code>-vv</code> to the command line. The first will activate debug output, which includes a lot of information about
Xgas discovery. <code>-vv</code> will also activate trace-level logging, which will output even more information about the
configuration as the program read it.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
